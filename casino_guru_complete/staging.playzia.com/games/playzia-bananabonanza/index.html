<!DOCTYPE html>

<html lang="en">

    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8"/>

        <!-- mobile meta tags -->
        <meta name="apple-mobile-web-app-status-bar-style" content="black"/>
        <meta name="apple-mobile-web-app-capable" content="yes"/>
        <meta name="apple-touch-fullscreen" content="yes"/>
        <meta name="msapplication-tap-highlight" content="no"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
        <meta name="mobile-web-app-capable" content="yes">

        <!-- Используем системные шрифты, так как оригинальные - заглушки -->
        <style>
            /* Используем системные шрифты, похожие на оригинальные */
            @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&family=Oswald:wght@400;700&family=Montserrat:wght@400;700;900&display=swap');
        </style>
        
        <!-- styles -->
        <link rel="stylesheet" href="./assets/html/global.css?v=1.0.0">
        <link rel="stylesheet" href="./assets/html/vex/vex.css?v=1.0.0"/>
        <link rel="stylesheet" href="./assets/html/vex/vex-theme-plain.css?v=1.0.0"/>

        <meta name="msapplication-TileColor" content="#ffffff">
        <meta name="theme-color" content="#ffffff">

        <!-- CSS для исправления шрифта и иконок -->
        <style>
            /* Загружаем оригинальные шрифты */
            @font-face {
                font-family: 'Impact';
                src: url('assets/html/fonts/Impact.woff2') format('woff2');
                font-weight: normal;
                font-style: normal;
            }
            
            @font-face {
                font-family: 'Roboto-Bold';
                src: url('assets/html/fonts/Roboto-Bold.woff2') format('woff2');
                font-weight: bold;
                font-style: normal;
            }
            
            @font-face {
                font-family: 'Arial Rounded MT Regular';
                src: url('assets/html/fonts/Arial Rounded MT Regular.woff') format('woff');
                font-weight: normal;
                font-style: normal;
            }
            
            @font-face {
                font-family: 'Myriad Pro Bold Condensed';
                src: url('assets/html/fonts/Myriad Pro Bold Condensed.woff') format('woff');
                font-weight: bold;
                font-style: normal;
            }
            
            @font-face {
                font-family: 'rockwell-regular';
                src: url('assets/html/fonts/rockwell-regular.woff2') format('woff2');
                font-weight: normal;
                font-style: normal;
            }
            
            @font-face {
                font-family: 'LEMONMILK-Bold';
                src: url('assets/html/fonts/LEMONMILK-Bold.woff2') format('woff2');
                font-weight: bold;
                font-style: normal;
            }
            
            /* Принудительная загрузка шрифтов */
            .font-preload {
                font-family: 'Impact', 'Roboto-Bold', 'Arial Rounded MT Regular', 'Myriad Pro Bold Condensed', 'rockwell-regular', 'LEMONMILK-Bold';
                position: absolute;
                left: -9999px;
                visibility: hidden;
            }
            /* Применяем оригинальные шрифты игры точно как в оригинале */
            
            /* Основной текст - стандартный шрифт без засечек */
            body, p, div, span, .text, .content, #settings_page_rules {
                font-family: 'Arial', 'Helvetica', sans-serif !important;
                font-weight: normal !important;
            }
            
            /* Заголовки и крупные элементы - толстый шрифт */
            h1, h2, h3, h4, h5, h6, .heading, .title, #settings_page_rules strong {
                font-family: 'Impact', 'Arial Black', Arial, sans-serif !important;
                font-weight: bold !important;
            }
            
            /* Очень толстые элементы как множитель и кнопка BET */
            .multiplier, .bet-button, .large-text {
                font-family: 'Impact', 'Arial Black', Arial, sans-serif !important;
                font-weight: 900 !important;
                font-stretch: condensed !important;
            }
            
            /* Специальные элементы используют Myriad Pro */
            .prize, #basicGameInfo, #coinFeatureHeading, #gameRoundInfoDivHeading {
                font-family: 'Myriad Pro Bold Condensed', Arial, sans-serif !important;
                font-weight: bold !important;
            }
            
            /* Версия игры - стандартный шрифт */
            .version-text {
                font-family: 'Arial', 'Helvetica', sans-serif !important;
                font-weight: normal !important;
            }
            
            /* Специфичные правила для элементов игры */
            
            /* Множитель в центре экрана - очень толстый шрифт */
            .multiplier-display, .crash-multiplier, .current-multiplier {
                font-family: 'Impact', 'Arial Black', Arial, sans-serif !important;
                font-weight: 900 !important;
                font-stretch: condensed !important;
                text-shadow: 2px 2px 4px rgba(0,0,0,0.5) !important;
            }
            
            /* Кнопка BET - очень толстый шрифт */
            .bet-btn, .bet-button, [class*="bet_btn"] {
                font-family: 'Impact', 'Arial Black', Arial, sans-serif !important;
                font-weight: 900 !important;
                font-stretch: condensed !important;
            }
            
            /* Кнопки ставок - стандартный шрифт */
            .bet-amount-btn, .bet-value-btn, [class*="bet_button"] {
                font-family: 'Arial', 'Helvetica', sans-serif !important;
                font-weight: normal !important;
            }
            
            /* Таймер - стандартный шрифт */
            .timer, .countdown, [class*="timer"] {
                font-family: 'Arial', 'Helvetica', sans-serif !important;
                font-weight: normal !important;
            }
            
            /* Множители в верхней панели - стандартный шрифт */
            .multiplier-btn, .multiplier-button, [class*="multiplier"] {
                font-family: 'Arial', 'Helvetica', sans-serif !important;
                font-weight: normal !important;
            }
            
            /* Поля ввода - стандартный шрифт */
            input, .input-field, [class*="input"] {
                font-family: 'Arial', 'Helvetica', sans-serif !important;
                font-weight: normal !important;
            }
            
            /* Текст "AUTO CASH" - стандартный шрифт */
            .auto-cash, .autocash, [class*="auto"] {
                font-family: 'Arial', 'Helvetica', sans-serif !important;
                font-weight: normal !important;
            }
            
            /* Баланс и BET VALUE - толстый шрифт */
            .balance, .bet-value, [class*="balance"], [class*="bet_value"] {
                font-family: 'Impact', 'Arial Black', Arial, sans-serif !important;
                font-weight: bold !important;
            }
            
            /* Специфичные правила для элементов интерфейса */
            
            /* Кнопка BET - очень толстый шрифт как в оригинале */
            .bet-btn, .bet-button, [class*="bet_btn"], button[class*="bet"] {
                font-family: 'Impact', 'Arial Black', Arial, sans-serif !important;
                font-weight: 900 !important;
                font-stretch: condensed !important;
                text-shadow: 1px 1px 2px rgba(0,0,0,0.3) !important;
            }
            
            /* AUTO CASH - толстый шрифт */
            .auto-cash, .autocash, [class*="auto"], [class*="Auto"] {
                font-family: 'Impact', 'Arial Black', Arial, sans-serif !important;
                font-weight: bold !important;
                text-transform: uppercase !important;
            }
            
            /* BET VALUE и BALANCE - очень толстый шрифт */
            .bet-value, .balance, [class*="bet_value"], [class*="balance"] {
                font-family: 'Impact', 'Arial Black', Arial, sans-serif !important;
                font-weight: 900 !important;
                font-stretch: condensed !important;
                text-transform: uppercase !important;
            }
            
            /* Значения множителей (1.11X) - толстый шрифт */
            .multiplier-value, .auto-multiplier, [class*="multiplier"], input[value*="X"] {
                font-family: 'Impact', 'Arial Black', Arial, sans-serif !important;
                font-weight: bold !important;
            }
            
            /* Значения ставок (1.00, 0.20) - толстый шрифт */
            .bet-amount, .bet-value-display, [class*="bet_amount"], input[type="text"] {
                font-family: 'Impact', 'Arial Black', Arial, sans-serif !important;
                font-weight: bold !important;
            }
            
            /* Кнопки быстрых ставок (100.00, 150.00) - толстый шрифт */
            .quick-bet, .bet-amount-btn, [class*="bet_button"] {
                font-family: 'Impact', 'Arial Black', Arial, sans-serif !important;
                font-weight: bold !important;
            }
            
            /* Агрессивные правила для всех элементов интерфейса */
            
            /* Все кнопки с текстом BET */
            button:contains("BET"), [class*="bet"]:contains("BET"), div:contains("BET") {
                font-family: 'Impact', 'Arial Black', Arial, sans-serif !important;
                font-weight: 900 !important;
                font-stretch: condensed !important;
            }
            
            /* Все элементы с текстом AUTO CASH */
            [class*="auto"]:contains("CASH"), [class*="Auto"]:contains("CASH"), div:contains("AUTO CASH") {
                font-family: 'Impact', 'Arial Black', Arial, sans-serif !important;
                font-weight: bold !important;
                text-transform: uppercase !important;
            }
            
            /* Все элементы с текстом BET VALUE */
            [class*="bet_value"], [class*="BetValue"], div:contains("BET VALUE") {
                font-family: 'Impact', 'Arial Black', Arial, sans-serif !important;
                font-weight: 900 !important;
                font-stretch: condensed !important;
                text-transform: uppercase !important;
            }
            
            /* Все элементы с текстом BALANCE */
            [class*="balance"], [class*="Balance"], div:contains("BALANCE") {
                font-family: 'Impact', 'Arial Black', Arial, sans-serif !important;
                font-weight: 900 !important;
                font-stretch: condensed !important;
                text-transform: uppercase !important;
            }
            
            /* Все элементы с множителями (X) */
            [class*="multiplier"], input[value*="X"], div:contains("X") {
                font-family: 'Impact', 'Arial Black', Arial, sans-serif !important;
                font-weight: bold !important;
            }
            
            /* Все элементы с числовыми значениями ставок */
            [class*="amount"], [class*="value"], input[type="text"], div:contains("€") {
                font-family: 'Impact', 'Arial Black', Arial, sans-serif !important;
                font-weight: bold !important;
            }
            
            /* Исправляем отображение иконок настроек */
            #settings_icon_holder {
                height: inherit !important;
                display: flex !important;
                align-items: center !important;
                width: 100% !important;
                position: absolute !important;
                color: #fff !important;
                z-index: 1 !important;
                margin-left: 14% !important;
            }
            
            #settings_icon_holder .icon {
                background: transparent !important;
                width: 30.33% !important;
            }
            
            #settings_icon_holder .icon_new {
                background: transparent !important;
                width: 33.33% !important;
            }
            
            #button_rules_menu, #button_settings_menu {
                width: 60px !important;
                height: 60px !important;
                background-size: 170px 60px !important;
                background-position: 2px 0 !important;
                position: relative !important;
                z-index: -1 !important;
                cursor: pointer !important;
                background-repeat: no-repeat !important;
                display: block !important;
            }
            
            #button_rules_menu {
                background-image: url('assets/html/images/settings/Rules_Btn.webp') !important;
            }
            
            #button_settings_menu {
                background-image: url('assets/html/images/settings/Setting_Btn.webp') !important;
            }
            
            .rules_lbl, .lang\:settings_rules_desk {
                display: block !important;
                font-size: 18px !important;
                color: #fff !important;
                text-align: center !important;
                margin-top: 5px !important;
                font-weight: 700 !important;
            }
            
            .lang\:settings_general_desk {
                display: block !important;
                font-size: 18px !important;
                color: #fff !important;
                text-align: center !important;
                margin-top: 5px !important;
                font-weight: 700 !important;
            }
        </style>
        
        <!-- Предзагрузка шрифтов -->
        <div class="font-preload" style="position: absolute; left: -9999px; visibility: hidden;">Impact Roboto-Bold Arial Rounded MT Regular Myriad Pro Bold Condensed rockwell-regular LEMONMILK-Bold</div>
        
        <!-- JavaScript для принудительного применения шрифтов -->
        <script>
            function applyOriginalFonts() {
                console.log('🎨 Применяем оригинальные шрифты...');
                
                // Функция для применения шрифта к элементу
                function applyFont(element, fontFamily, fontWeight = 'bold') {
                    if (element) {
                        element.style.fontFamily = fontFamily + ' !important';
                        element.style.fontWeight = fontWeight + ' !important';
                        element.style.fontStretch = 'condensed !important';
                    }
                }
                
                // Применяем шрифты к элементам с текстом BET
                document.querySelectorAll('*').forEach(el => {
                    if (el.textContent && el.textContent.includes('BET')) {
                        applyFont(el, 'Impact, Arial Black, Arial', '900');
                    }
                });
                
                // Применяем шрифты к элементам с текстом AUTO CASH
                document.querySelectorAll('*').forEach(el => {
                    if (el.textContent && el.textContent.includes('AUTO CASH')) {
                        applyFont(el, 'Impact, Arial Black, Arial', 'bold');
                    }
                });
                
                // Применяем шрифты к элементам с текстом BET VALUE
                document.querySelectorAll('*').forEach(el => {
                    if (el.textContent && el.textContent.includes('BET VALUE')) {
                        applyFont(el, 'Impact, Arial Black, Arial', '900');
                    }
                });
                
                // Применяем шрифты к элементам с текстом BALANCE
                document.querySelectorAll('*').forEach(el => {
                    if (el.textContent && el.textContent.includes('BALANCE')) {
                        applyFont(el, 'Impact, Arial Black, Arial', '900');
                    }
                });
                
                // Применяем шрифты к элементам с множителями (X)
                document.querySelectorAll('*').forEach(el => {
                    if (el.textContent && el.textContent.includes('X') && el.textContent.match(/\d+\.\d+X/)) {
                        applyFont(el, 'Impact, Arial Black, Arial', 'bold');
                    }
                });
                
                // Применяем шрифты к элементам с числовыми значениями
                document.querySelectorAll('*').forEach(el => {
                    if (el.textContent && el.textContent.match(/\d+\.\d+/)) {
                        applyFont(el, 'Impact, Arial Black, Arial', 'bold');
                    }
                });
                
                console.log('✅ Оригинальные шрифты применены');
            }
            
            // Применяем шрифты сразу и через интервалы
            setTimeout(applyOriginalFonts, 1000);
            setTimeout(applyOriginalFonts, 3000);
            setTimeout(applyOriginalFonts, 5000);
            
            // Применяем шрифты при изменении DOM
            const observer = new MutationObserver(applyOriginalFonts);
            observer.observe(document.body, { childList: true, subtree: true });
        </script>
        
        <!-- ПРИНУДИТЕЛЬНЫЙ CSS БЛОКЕР -->
        <style>
            /* ПРИНУДИТЕЛЬНЫЙ CSS БЛОКЕР */
            .force-blocked {
                pointer-events: none !important;
                opacity: 0.5 !important;
                cursor: not-allowed !important;
                filter: grayscale(100%) !important;
            }
            
            .force-blocked * {
                pointer-events: none !important;
            }
            
            /* Блокер для canvas */
            .force-blocked-canvas {
                pointer-events: none !important;
                opacity: 0.5 !important;
                filter: grayscale(100%) !important;
            }
            
            /* Блокер для всех интерактивных элементов */
            .force-blocked button,
            .force-blocked [role="button"],
            .force-blocked .button,
            .force-blocked .btn,
            .force-blocked [data-button],
            .force-blocked [onclick],
            .force-blocked .interactive {
                pointer-events: none !important;
                opacity: 0.5 !important;
                cursor: not-allowed !important;
                filter: grayscale(100%) !important;
            }
        </style>

    </head>

    <body onload="loadGame()">
        <script>
            // ПРИНУДИТЕЛЬНЫЙ БЛОКЕР КНОПОК
            window.__forceButtonBlocker = {
                isBlocked: false,
                blockedButtons: new Set(),
                
                blockAll: function() {
                    console.log('🔒 ПРИНУДИТЕЛЬНАЯ БЛОКИРОВКА ВСЕХ КНОПОК!');
                    this.isBlocked = true;
                    
                    // Активируем агрессивный блокер событий
                    window.startAggressiveBlocker();
                    
                    // Блокируем через CSS классы - самый надежный способ
                    document.body.classList.add('force-blocked');
                    
                    // Блокируем canvas если есть
                    const canvas = document.querySelector('canvas');
                    if (canvas) {
                        canvas.classList.add('force-blocked-canvas');
                        console.log('🔒 Canvas заблокирован через CSS');
                    }
                    
                    // Блокируем через DOM
                    const buttonSelectors = [
                        'button', '[role="button"]', '.button', '.btn',
                        '[data-button]', '[onclick]', '.interactive'
                    ];
                    
                    buttonSelectors.forEach(selector => {
                        document.querySelectorAll(selector).forEach(btn => {
                            btn.classList.add('force-blocked');
                            this.blockedButtons.add(btn);
                        });
                    });
                    
                    // Блокируем через PIXI объекты
                    if (window.__gameRenderer && window.__gameRenderer.SceneManager) {
                        const sceneInstance = window.__gameRenderer.SceneManager.getCurrentScene();
                        if (sceneInstance) {
                            const buttonNames = [
                                'first_bet_button', 'second_bet_button', 'third_bet_button', 'fourth_bet_button',
                                'first_bet_button_2', 'second_bet_button_2', 'third_bet_button_2', 'fourth_bet_button_2',
                                'plus_button', 'minus_button', 'plus_button_2', 'minus_button_2',
                                'bet_plus_btn', 'bet_minus_btn', 'bet_plus_btn_2', 'bet_minus_btn_2',
                                'autoCashOutToggle1', 'autoCashOutToggle2',
                                'bet_btn_first', 'bet_btn_second'
                            ];
                            
                            buttonNames.forEach(buttonName => {
                                if (sceneInstance[buttonName]) {
                                    sceneInstance[buttonName].interactive = false;
                                    sceneInstance[buttonName].alpha = 0.5;
                                    sceneInstance[buttonName].buttonMode = false;
                                    if (sceneInstance[buttonName].updateButtonState) {
                                        sceneInstance[buttonName].updateButtonState(false);
                                    }
                                    console.log(`🔒 ПРИНУДИТЕЛЬНО заблокирована ${buttonName}`);
                                }
                            });
                        }
                    }
                },
                
                unblockAll: function() {
                    console.log('🔓 ПРИНУДИТЕЛЬНАЯ РАЗБЛОКИРОВКА ВСЕХ КНОПОК!');
                    this.isBlocked = false;
                    
                    // Отключаем агрессивный блокер событий
                    window.stopAggressiveBlocker();
                    
                    // Разблокируем через CSS классы
                    document.body.classList.remove('force-blocked');
                    
                    // Разблокируем canvas
                    const canvas = document.querySelector('canvas');
                    if (canvas) {
                        canvas.classList.remove('force-blocked-canvas');
                        console.log('🔓 Canvas разблокирован через CSS');
                    }
                    
                    // Разблокируем DOM кнопки
                    this.blockedButtons.forEach(btn => {
                        btn.classList.remove('force-blocked');
                    });
                    this.blockedButtons.clear();
                    
                    // Разблокируем PIXI объекты
                    if (window.__gameRenderer && window.__gameRenderer.SceneManager) {
                        const sceneInstance = window.__gameRenderer.SceneManager.getCurrentScene();
                        if (sceneInstance) {
                            const buttonNames = [
                                'first_bet_button', 'second_bet_button', 'third_bet_button', 'fourth_bet_button',
                                'first_bet_button_2', 'second_bet_button_2', 'third_bet_button_2', 'fourth_bet_button_2',
                                'plus_button', 'minus_button', 'plus_button_2', 'minus_button_2',
                                'bet_plus_btn', 'bet_minus_btn', 'bet_plus_btn_2', 'bet_minus_btn_2',
                                'autoCashOutToggle1', 'autoCashOutToggle2',
                                'bet_btn_first', 'bet_btn_second'
                            ];
                            
                            buttonNames.forEach(buttonName => {
                                if (sceneInstance[buttonName]) {
                                    sceneInstance[buttonName].interactive = true;
                                    sceneInstance[buttonName].alpha = 1.0;
                                    sceneInstance[buttonName].buttonMode = true;
                                    if (sceneInstance[buttonName].updateButtonState) {
                                        sceneInstance[buttonName].updateButtonState(true);
                                    }
                                    console.log(`🔓 ПРИНУДИТЕЛЬНО разблокирована ${buttonName}`);
                                }
                            });
                        }
                    }
                }
            };
            
            // Глобальные функции для принудительной блокировки
            window.forceBlockButtons = () => window.__forceButtonBlocker.blockAll();
            window.forceUnblockButtons = () => window.__forceButtonBlocker.unblockAll();
            
            // АГРЕССИВНЫЙ БЛОКЕР СОБЫТИЙ
            window.__aggressiveBlocker = {
                isActive: false,
                originalAddEventListener: null,
                
                start: function() {
                    if (this.isActive) return;
                    console.log('🚫 АГРЕССИВНЫЙ БЛОКЕР СОБЫТИЙ АКТИВИРОВАН!');
                    this.isActive = true;
                    
                    // Перехватываем все события мыши
                    document.addEventListener('click', this.blockEvent, true);
                    document.addEventListener('mousedown', this.blockEvent, true);
                    document.addEventListener('mouseup', this.blockEvent, true);
                    document.addEventListener('pointerdown', this.blockEvent, true);
                    document.addEventListener('pointerup', this.blockEvent, true);
                    document.addEventListener('touchstart', this.blockEvent, true);
                    document.addEventListener('touchend', this.blockEvent, true);
                },
                
                stop: function() {
                    if (!this.isActive) return;
                    console.log('✅ АГРЕССИВНЫЙ БЛОКЕР СОБЫТИЙ ОТКЛЮЧЕН!');
                    this.isActive = false;
                    
                    document.removeEventListener('click', this.blockEvent, true);
                    document.removeEventListener('mousedown', this.blockEvent, true);
                    document.removeEventListener('mouseup', this.blockEvent, true);
                    document.removeEventListener('pointerdown', this.blockEvent, true);
                    document.removeEventListener('pointerup', this.blockEvent, true);
                    document.removeEventListener('touchstart', this.blockEvent, true);
                    document.removeEventListener('touchend', this.blockEvent, true);
                },
                
                blockEvent: function(event) {
                    console.log('🚫 СОБЫТИЕ ЗАБЛОКИРОВАНО:', event.type, event.target);
                    event.preventDefault();
                    event.stopPropagation();
                    event.stopImmediatePropagation();
                    return false;
                }
            };
            
            // Глобальные функции для агрессивного блокера
            window.startAggressiveBlocker = () => window.__aggressiveBlocker.start();
            window.stopAggressiveBlocker = () => window.__aggressiveBlocker.stop();
            
            // Глобальный логгер для отслеживания состояния игры
            window.__gameStateLogger = {
                logState: function() {
                    console.log('🔍 === СОСТОЯНИЕ ИГРЫ ===');
                    if (window.__gameRenderer && window.__gameRenderer.SceneManager) {
                        const sceneInstance = window.__gameRenderer.SceneManager.getCurrentScene();
                        if (sceneInstance) {
                            console.log('🔍 Флаг кешаута в сцене:', sceneInstance.__cashoutExecuted);
                            console.log('🔍 Флаг блокировки кнопок:', sceneInstance.__betButtonsBlocked);
                        }
                    }
                    if (window.__ws && window.__ws.__roundState) {
                        console.log('🔍 Фаза раунда:', window.__ws.__roundState.phase);
                        console.log('🔍 Флаг кешаута в раунде:', window.__ws.__roundState.cashoutExecuted);
                        console.log('🔍 Множитель:', window.__ws.__roundState.multiplier);
                    }
                    console.log('🔍 ===================');
                },
                
                resetCashoutFlag: function() {
                    console.log('🔄 ПРИНУДИТЕЛЬНЫЙ СБРОС ФЛАГА КЕШАУТА');
                    if (window.__gameRenderer && window.__gameRenderer.SceneManager) {
                        const sceneInstance = window.__gameRenderer.SceneManager.getCurrentScene();
                        if (sceneInstance) {
                            sceneInstance.__cashoutExecuted = false;
                            console.log('✅ Флаг кешаута сброшен в сцене');
                        }
                    }
                    if (window.__ws && window.__ws.__roundState) {
                        window.__ws.__roundState.cashoutExecuted = false;
                        console.log('✅ Флаг кешаута сброшен в раунде');
                    }
                    this.logState();
                }
            };
            
            // Добавляем глобальные функции для отладки
            window.resetCashoutFlag = () => window.__gameStateLogger.resetCashoutFlag();
            window.logGameState = () => window.__gameStateLogger.logState();
            
            // Функция для принудительного показа WIN
            window.showWin = (amount = null) => {
                console.log('💰 Принудительный показ WIN');
                const currentMultiplier = window.__ws && window.__ws.__roundState ? window.__ws.__roundState.multiplier : 1.0;
                const winAmount = amount || (100.0 * currentMultiplier);
                console.log('💰 Сумма WIN:', winAmount);
                
                // Обновляем DOM элементы
                const winElements = ['#cp_win', '.win_amount', '.win-text', '[data-win]'];
                winElements.forEach(selector => {
                    const element = document.querySelector(selector);
                    if (element) {
                        element.textContent = `WIN €${winAmount.toFixed(2)}`;
                        element.style.display = 'block';
                        element.style.visibility = 'visible';
                        console.log(`💰 Показан WIN в ${selector}:`, winAmount);
                    }
                });
                
                // Вызываем анимацию WIN если доступна
                if (window.__gameRenderer && window.__gameRenderer.SceneManager) {
                    const sceneInstance = window.__gameRenderer.SceneManager.getCurrentScene();
                    if (sceneInstance && sceneInstance.showWinTextAnimation) {
                        try {
                            sceneInstance.showWinTextAnimation(winAmount);
                            console.log('💰 Вызвана анимация WIN:', winAmount);
                        } catch (error) {
                            console.error('💰 Ошибка при вызове showWinTextAnimation:', error);
                        }
                    }
                }
                
                // WIN остается видимым до конца раунда
                console.log('💰 WIN показан и остается видимым до конца раунда');
            };
            
            // Функция для скрытия WIN
            window.hideWin = () => {
                console.log('🕐 Скрываем WIN');
                const winElements = ['#cp_win', '.win_amount', '.win-text', '[data-win]'];
                winElements.forEach(selector => {
                    const element = document.querySelector(selector);
                    if (element) {
                        element.style.display = 'none';
                        element.style.visibility = 'hidden';
                        element.textContent = ''; // Очищаем текст
                        console.log(`🕐 Скрыт WIN в ${selector}`);
                    }
                });
            };
            // WebSocket мок для офлайн режима - должен быть ПЕРВЫМ!
            (function () {
                console.log('🎮 Инициализируем WebSocket мок в игре...');
                
                const listeners = (ws) => ({
                    open: () => {
                        console.log('🔌 WebSocket мок подключен');
                        ws.onopen && ws.onopen({});
                    },
                    tick() {
                        if (ws.__closed) return;
                        
                        // Инициализируем состояние раунда если нужно
                        if (!ws.__roundState) {
                            ws.__roundState = {
                                phase: 'waiting', // waiting, countdown, active, crash_animation, ended, open
                                roundId: 'offline_round_' + Date.now(),
                                startTime: Date.now(),
                                countdownTime: 10,
                                multiplier: 1.00,
                                maxMultiplier: 0,
                                crashAnimationTime: 0
                            };
                        }
                        
                        // Инициализируем баланс если нужно
                        if (ws.__currentBalance === undefined) {
                            ws.__currentBalance = 100000000; // Начальный баланс 100,000,000 центов = 1,000,000.00 EUR
                            console.log('💰 Инициализирован баланс:', ws.__currentBalance);
                        }
                        
                        const now = Date.now();
                        const state = ws.__roundState;
                        
                        // Логика фаз раунда
                        if (state.phase === 'waiting') {
                            // Переходим к отсчету
                            state.phase = 'countdown';
                            state.countdownTime = 10;
                            state.lastCountdownUpdate = now; // Инициализируем таймер
                            console.log('🕐 Начинаем отсчет до нового раунда...');
                            
                            // Переключаем анимацию на idle состояние
                            if (window.__setAnimationPhase) {
                                window.__setAnimationPhase('idle');
                            }
                            
                            // Отправляем событие getready для активации UI ожидания
                            setTimeout(() => {
                                try {
                                    const getReadyEvent = {
                                        rounds: [{
                                            id: state.roundId,
                                            status: 'getready',
                                            currentMultiplier: 1.00,
                                            maxMultiplier: 0,
                                            timeToStartInSeconds: state.countdownTime
                                        }]
                                    };
                                    
                                    if (window.__gameApp) {
                                        window.__gameApp.emit('gameInProgress', getReadyEvent);
                                        window.__gameApp.emit('WAITING_START');
                                        window.__gameApp.emit('ROUND_WAITING');
                                    }
                                    
                                    console.log('🎯 Отправлено событие getready для UI ожидания');
                                } catch (error) {
                                    console.log('⚠️ Ошибка отправки события getready:', error);
                                }
                            }, 100);
                        } else if (state.phase === 'countdown') {
                            // Обновляем countdown только каждую секунду
                            if (!state.lastCountdownUpdate || (now - state.lastCountdownUpdate) >= 1000) {
                                state.countdownTime--;
                                state.lastCountdownUpdate = now;
                                console.log(`⏰ Осталось секунд: ${state.countdownTime}`);
                            }
                            
                            if (state.countdownTime <= 0) {
                                state.phase = 'active';
                                state.multiplier = 1.00;
                                state.roundId = 'offline_round_' + now;
                                state.maxMultiplier = 0; // Сбрасываем максимальный множитель
                                
                                // Сбрасываем флаг кешаута для нового активного раунда
                                if (ws.__roundState) {
                                    ws.__roundState.cashoutExecuted = false;
                                    console.log('🔄 Флаг кешаута сброшен в WebSocket моке для нового раунда');
                                }
                                
                                if (window.__gameRenderer && window.__gameRenderer.SceneManager) {
                                    const sceneInstance = window.__gameRenderer.SceneManager.getCurrentScene();
                                    if (sceneInstance) {
                                        sceneInstance.__cashoutExecuted = false;
                                        console.log('🔄 Флаг кешаута сброшен для нового активного раунда');
                                    }
                                }
                                state.crashAnimationTime = 0; // Сбрасываем время анимации краша
                                
                                // Сбрасываем флаг кешаута в сцене
                                if (ws.__roundState) {
                                    ws.__roundState.cashoutExecuted = false;
                                    console.log('🔄 Флаг кешаута сброшен в WebSocket моке в начале раунда');
                                }
                                
                                // Сбрасываем флаг кешаута в глобальном состоянии
                                if (ws.__roundState) {
                                    ws.__roundState.cashoutExecuted = false;
                                    console.log('🔄 Флаг кешаута сброшен в глобальном состоянии в начале раунда');
                                }
                                
                                // Скрываем WIN в начале нового раунда
                                console.log('🕐 Скрываем WIN в начале нового раунда');
                                const winElements = ['#cp_win', '.win_amount', '.win-text', '[data-win]'];
                                winElements.forEach(selector => {
                                    const element = document.querySelector(selector);
                                    if (element) {
                                        element.style.display = 'none';
                                        element.style.visibility = 'hidden';
                                        element.textContent = ''; // Очищаем текст
                                        console.log(`🕐 Скрыт WIN в ${selector} в начале раунда`);
                                    }
                                });
                                
                                // Сбрасываем флаг кешаута в глобальном состоянии
                                if (ws.__roundState) {
                                    ws.__roundState.cashoutExecuted = false;
                                    console.log('🔄 Флаг кешаута сброшен в глобальном состоянии в начале раунда');
                                }
                                
                                if (window.__gameRenderer && window.__gameRenderer.SceneManager) {
                                    const sceneInstance = window.__gameRenderer.SceneManager.getCurrentScene();
                                    if (sceneInstance) {
                                        sceneInstance.__cashoutExecuted = false;
                                        console.log('🔄 Флаг кешаута сброшен в начале раунда');
                                    }
                                }
                                
                                console.log('🚀 Раунд начался!');
                                
                                // Переключаем анимацию на фазу роста
                                setTimeout(() => {
                                    try {
                                        // Переключаем анимацию на фазу роста
                                        if (window.__setAnimationPhase) {
                                            window.__setAnimationPhase('rising');
                                        }
                                        
                                        // Попытка перезапустить анимацию через игровые объекты
                                        if (window.__gameApp) {
                                            window.__gameApp.emit('START_GAME');
                                            window.__gameApp.emit('ROUND_START');
                                            console.log('🔄 Отправлены события перезапуска анимации');
                                        }
                                        
                                    } catch (error) {
                                        console.log('⚠️ Ошибка перезапуска анимации:', error);
                                    }
                                }, 200);
                            }
                        } else if (state.phase === 'active') {
                            // Увеличиваем множитель более плавно - каждые 100мс
                            state.multiplier += (0.001 + Math.random() * 0.003) * 2.5; // Ускоряем множитель в 1.8 раза
                            
                            // Проверяем автокешаут
                            if (window.__gameRenderer && window.__gameRenderer.SceneManager) {
                                const sceneInstance = window.__gameRenderer.SceneManager.getCurrentScene();
                                if (sceneInstance) {
                                    const currentMultiplier = state.multiplier;
                                    
                                    // Проверяем автокешаут через UI элементы (более надежный способ)
                                    if (sceneInstance.autoCashOutToggle1 && sceneInstance.autoCashOutToggle1.checked) {
                                        const autoCashOutValue = sceneInstance.autoCashOutValue1 || 1.50; // По умолчанию 1.50x
                                        if (currentMultiplier >= autoCashOutValue) {
                                            console.log(`🤖 Автокешаут сработал через UI на множителе: ${currentMultiplier.toFixed(2)}x (установлен: ${autoCashOutValue.toFixed(2)}x)`);
                                            if (sceneInstance.onCashOutButtonClick) {
                                                sceneInstance.onCashOutButtonClick(['cash_out_btn']);
                                            }
                                            sceneInstance.autoCashOutToggle1.checked = false; // Отключаем автокешаут
                                        }
                                    }
                                    
                                    // Проверяем автокешаут для первой ставки
                                    if (sceneInstance.betData && sceneInstance.betData.bet1 && sceneInstance.betData.bet1.autoCashOutMultiplier > 0) {
                                        const autoCashOutMultiplier = sceneInstance.betData.bet1.autoCashOutMultiplier / 100;
                                        if (currentMultiplier >= autoCashOutMultiplier) {
                                            console.log(`🤖 Автокешаут сработал для bet1 на множителе: ${currentMultiplier.toFixed(2)}x (установлен: ${autoCashOutMultiplier.toFixed(2)}x)`);
                                            if (sceneInstance.onCashOutButtonClick) {
                                                sceneInstance.onCashOutButtonClick(['cash_out_btn']);
                                            }
                                            sceneInstance.betData.bet1.autoCashOutMultiplier = 0; // Reset auto-cashout
                                        }
                                    }
                                    
                                    // Проверяем автокешаут для второй ставки
                                    if (sceneInstance.betData && sceneInstance.betData.bet2 && sceneInstance.betData.bet2.autoCashOutMultiplier > 0) {
                                        const autoCashOutMultiplier = sceneInstance.betData.bet2.autoCashOutMultiplier / 100;
                                        if (currentMultiplier >= autoCashOutMultiplier) {
                                            console.log(`🤖 Автокешаут сработал для bet2 на множителе: ${currentMultiplier.toFixed(2)}x (установлен: ${autoCashOutMultiplier.toFixed(2)}x)`);
                                            if (sceneInstance.onCashOutButtonClick) {
                                                sceneInstance.onCashOutButtonClick(['cash_out_btn_2']);
                                            }
                                            sceneInstance.betData.bet2.autoCashOutMultiplier = 0; // Reset auto-cashout
                                        }
                                    }
                                }
                            }
                            
                            // Случайно завершаем раунд (краш) - уменьшаем вероятность
                            if (Math.random() < 0.003) { // 0.3% шанс краша каждые 100мс
                                state.phase = 'crash_animation';
                                state.maxMultiplier = state.multiplier;
                                state.crashAnimationTime = 0;
                                console.log(`💥 Раунд завершен! Множитель: ${state.multiplier.toFixed(2)}x`);
                                
                                // Сразу вызываем onGameFinished для проигрывания анимации FELL OFF
                                setTimeout(() => {
                                    if (window.__gameRenderer && window.__gameRenderer.SceneManager) {
                                        const sceneInstance = window.__gameRenderer.SceneManager.getCurrentScene();
                                        if (sceneInstance && sceneInstance.onGameFinished) {
                                            // Проверяем, есть ли активные ставки
                                            let hasActiveBets = false;
                                            if (sceneInstance.betData) {
                                                hasActiveBets = (sceneInstance.betData.bet1 && sceneInstance.betData.bet1.stake > 0) || 
                                                               (sceneInstance.betData.bet2 && sceneInstance.betData.bet2.stake > 0);
                                            }
                                            
                                            // Создаем объект события окончания игры
                                            const gameFinishedEvent = {
                                                isCashout: false, // Ставки сгорят (если есть)
                                                result: {
                                                    result: {
                                                        maxMultiplier: state.maxMultiplier
                                                    }
                                                }
                                            };
                                            
                                            console.log('🎬 Вызываем onGameFinished для анимации FELL OFF при краше');
                                            sceneInstance.onGameFinished(gameFinishedEvent);
                                        }
                                    }
                                }, 50);
                            }
                        } else if (state.phase === 'crash_animation') {
                            // Ждем завершения анимации падения (2 секунды)
                            state.crashAnimationTime += 0.1; // Увеличиваем на 100мс
                            if (state.crashAnimationTime >= 2.0) {
                                state.phase = 'ended';
                                console.log('🎬 Анимация падения завершена, переходим к ожиданию...');
                                
                                // Скрываем WIN в конце раунда
                                console.log('🕐 Скрываем WIN в конце раунда');
                                const winElements = ['#cp_win', '.win_amount', '.win-text', '[data-win]'];
                                winElements.forEach(selector => {
                                    const element = document.querySelector(selector);
                                    if (element) {
                                        element.style.display = 'none';
                                        element.style.visibility = 'hidden';
                                        element.textContent = ''; // Очищаем текст
                                        console.log(`🕐 Скрыт WIN в ${selector} в конце раунда`);
                                    }
                                });
                            }
                        } else if (state.phase === 'ended') {
                            // Ждем 3 секунды и начинаем новый раунд
                            if (!state.endTimer) {
                                state.endTimer = true;
                                
                                // Отправляем событие окончания раунда СРАЗУ
                                const roundEndEvent = {
                                    rounds: [{
                                        id: state.roundId,
                                        status: 'ended',
                                        currentMultiplier: 0,
                                        maxMultiplier: +state.maxMultiplier.toFixed(2),
                                        timeToStartInSeconds: 0
                                    }]
                                };
                                
                                // Принудительно вызываем обработку окончания
                                setTimeout(() => {
                                    try {
                                        if (window.__gameApp) {
                                            window.__gameApp.emit('gameInProgress', roundEndEvent);
                                            console.log('💥 Отправлено событие окончания раунда');
                                        }
                                        ws.onmessage && ws.onmessage({ data: JSON.stringify(roundEndEvent) });
                                    } catch (error) {
                                        console.log('⚠️ Ошибка отправки события окончания:', error);
                                    }
                                }, 100);
                                
                                // Разблокируем кнопки ставок после завершения раунда
                                setTimeout(() => {
                                    if (window.__gameRenderer && window.__gameRenderer.SceneManager) {
                                        const sceneInstance = window.__gameRenderer.SceneManager.getCurrentScene();
                                        if (sceneInstance && sceneInstance.__betButtonsBlocked) {
                                            console.log('🔓 Разблокируем кнопки ставок после завершения раунда...');
                                            sceneInstance.__betButtonsBlocked = false;
                                            
                                            // Разблокируем кнопки выбора ставок с восстановлением визуального состояния
                                            if (sceneInstance.first_bet_button) {
                                                sceneInstance.first_bet_button.updateButtonState(true);
                                                sceneInstance.first_bet_button.interactive = true;
                                                sceneInstance.first_bet_button.tint = 0xFFFFFF; // Восстанавливаем оригинальный цвет
                                                sceneInstance.first_bet_button.alpha = 1.0; // Восстанавливаем яркость
                                            }
                                            if (sceneInstance.second_bet_button) {
                                                sceneInstance.second_bet_button.updateButtonState(true);
                                                sceneInstance.second_bet_button.interactive = true;
                                                sceneInstance.second_bet_button.tint = 0xFFFFFF; // Восстанавливаем оригинальный цвет
                                                sceneInstance.second_bet_button.alpha = 1.0; // Восстанавливаем яркость
                                            }
                                            if (sceneInstance.third_bet_button) {
                                                sceneInstance.third_bet_button.updateButtonState(true);
                                                sceneInstance.third_bet_button.interactive = true;
                                                sceneInstance.third_bet_button.tint = 0xFFFFFF; // Восстанавливаем оригинальный цвет
                                                sceneInstance.third_bet_button.alpha = 1.0; // Восстанавливаем яркость
                                            }
                                            if (sceneInstance.fourth_bet_button) {
                                                sceneInstance.fourth_bet_button.updateButtonState(true);
                                                sceneInstance.fourth_bet_button.interactive = true;
                                                sceneInstance.fourth_bet_button.tint = 0xFFFFFF; // Восстанавливаем оригинальный цвет
                                                sceneInstance.fourth_bet_button.alpha = 1.0; // Восстанавливаем яркость
                                            }
                                            
                                            // Разблокируем кнопки +/- ставок с восстановлением визуального состояния
                                            if (sceneInstance.bet_minus_btn) {
                                                sceneInstance.bet_minus_btn.updateButtonState(true);
                                                sceneInstance.bet_minus_btn.interactive = true;
                                                sceneInstance.bet_minus_btn.alpha = 1.0; // Восстанавливаем яркость
                                            }
                                            if (sceneInstance.bet_plus_btn) {
                                                sceneInstance.bet_plus_btn.updateButtonState(true);
                                                sceneInstance.bet_plus_btn.interactive = true;
                                                sceneInstance.bet_plus_btn.alpha = 1.0; // Восстанавливаем яркость
                                            }
                                            
                                            // Разблокируем дополнительные кнопки +/-
                                            if (sceneInstance.plus_button) {
                                                sceneInstance.plus_button.interactive = true;
                                                sceneInstance.plus_button.tint = 0xFFFFFF; // Восстанавливаем оригинальный цвет
                                                sceneInstance.plus_button.alpha = 1.0;
                                            }
                                            if (sceneInstance.minus_button) {
                                                sceneInstance.minus_button.interactive = true;
                                                sceneInstance.minus_button.tint = 0xFFFFFF; // Восстанавливаем оригинальный цвет
                                                sceneInstance.minus_button.alpha = 1.0;
                                            }
                                            
                                            // Разблокируем все кнопки ставок
                                            const buttonsToUnblock = [
                                                'first_bet_button', 'second_bet_button', 'third_bet_button', 'fourth_bet_button',
                                                'first_bet_button_2', 'second_bet_button_2', 'third_bet_button_2', 'fourth_bet_button_2',
                                                'plus_button', 'minus_button', 'plus_button_2', 'minus_button_2',
                                                'bet_plus_btn', 'bet_minus_btn', 'bet_plus_btn_2', 'bet_minus_btn_2',
                                                'autoCashOutToggle1', 'autoCashOutToggle2',
                                                'bet_btn_first', 'bet_btn_second'
                                            ];
                                            
                                            buttonsToUnblock.forEach(buttonName => {
                                                if (sceneInstance[buttonName]) {
                                                    if (sceneInstance[buttonName].updateButtonState) {
                                                        sceneInstance[buttonName].updateButtonState(true);
                                                    }
                                                    sceneInstance[buttonName].interactive = true;
                                                    sceneInstance[buttonName].tint = 0xFFFFFF; // Восстанавливаем оригинальный цвет
                                                    sceneInstance[buttonName].alpha = 1.0;
                                                }
                                            });
                                            
                                            // Разблокируем кнопки автокешаута с восстановлением визуального состояния
                                            if (sceneInstance.autoCashOutToggle1) {
                                                sceneInstance.autoCashOutToggle1.interactive = true;
                                                sceneInstance.autoCashOutToggle1.tint = 0xFFFFFF; // Восстанавливаем оригинальный цвет
                                                sceneInstance.autoCashOutToggle1.alpha = 1.0; // Восстанавливаем яркость
                                            }
                                            
                                            // Разблокируем кнопку BET
                                            if (sceneInstance.bet_btn_first) {
                                                sceneInstance.bet_btn_first.updateButtonState(true);
                                                sceneInstance.bet_btn_first.interactive = true;
                                                sceneInstance.bet_btn_first.tint = 0xFFFFFF; // Восстанавливаем оригинальный цвет
                                                sceneInstance.bet_btn_first.alpha = 1.0; // Восстанавливаем яркость
                                            }
                                            
                                            // Разблокируем кнопки для второй панели с восстановлением визуального состояния
                                            if (sceneInstance.first_bet_button_2) {
                                                sceneInstance.first_bet_button_2.updateButtonState(true);
                                                sceneInstance.first_bet_button_2.interactive = true;
                                                sceneInstance.first_bet_button_2.tint = 0xFFFFFF; // Восстанавливаем оригинальный цвет
                                                sceneInstance.first_bet_button_2.alpha = 1.0; // Восстанавливаем яркость
                                            }
                                            if (sceneInstance.second_bet_button_2) {
                                                sceneInstance.second_bet_button_2.updateButtonState(true);
                                                sceneInstance.second_bet_button_2.interactive = true;
                                                sceneInstance.second_bet_button_2.tint = 0xFFFFFF; // Восстанавливаем оригинальный цвет
                                                sceneInstance.second_bet_button_2.alpha = 1.0; // Восстанавливаем яркость
                                            }
                                            if (sceneInstance.third_bet_button_2) {
                                                sceneInstance.third_bet_button_2.updateButtonState(true);
                                                sceneInstance.third_bet_button_2.interactive = true;
                                                sceneInstance.third_bet_button_2.tint = 0xFFFFFF; // Восстанавливаем оригинальный цвет
                                                sceneInstance.third_bet_button_2.alpha = 1.0; // Восстанавливаем яркость
                                            }
                                            if (sceneInstance.fourth_bet_button_2) {
                                                sceneInstance.fourth_bet_button_2.updateButtonState(true);
                                                sceneInstance.fourth_bet_button_2.interactive = true;
                                                sceneInstance.fourth_bet_button_2.tint = 0xFFFFFF; // Восстанавливаем оригинальный цвет
                                                sceneInstance.fourth_bet_button_2.alpha = 1.0; // Восстанавливаем яркость
                                            }
                                            
                                            if (sceneInstance.bet_minus_btn_2) {
                                                sceneInstance.bet_minus_btn_2.updateButtonState(true);
                                                sceneInstance.bet_minus_btn_2.interactive = true;
                                                sceneInstance.bet_minus_btn_2.tint = 0xFFFFFF; // Восстанавливаем оригинальный цвет
                                                sceneInstance.bet_minus_btn_2.alpha = 1.0; // Восстанавливаем яркость
                                            }
                                            if (sceneInstance.bet_plus_btn_2) {
                                                sceneInstance.bet_plus_btn_2.updateButtonState(true);
                                                sceneInstance.bet_plus_btn_2.interactive = true;
                                                sceneInstance.bet_plus_btn_2.tint = 0xFFFFFF; // Восстанавливаем оригинальный цвет
                                                sceneInstance.bet_plus_btn_2.alpha = 1.0; // Восстанавливаем яркость
                                            }
                                            
                                            // Разблокируем дополнительные кнопки +/- для второй панели
                                            if (sceneInstance.plus_button_2) {
                                                sceneInstance.plus_button_2.interactive = true;
                                                sceneInstance.plus_button_2.tint = 0xFFFFFF; // Восстанавливаем оригинальный цвет
                                                sceneInstance.plus_button_2.alpha = 1.0;
                                            }
                                            if (sceneInstance.minus_button_2) {
                                                sceneInstance.minus_button_2.interactive = true;
                                                sceneInstance.minus_button_2.tint = 0xFFFFFF; // Восстанавливаем оригинальный цвет
                                                sceneInstance.minus_button_2.alpha = 1.0;
                                            }
                                            
                                            if (sceneInstance.autoCashOutToggle2) {
                                                sceneInstance.autoCashOutToggle2.interactive = true;
                                                sceneInstance.autoCashOutToggle2.tint = 0xFFFFFF; // Восстанавливаем оригинальный цвет
                                                sceneInstance.autoCashOutToggle2.alpha = 1.0; // Восстанавливаем яркость
                                            }
                                            
                                            // Разблокируем кнопку BET для второй панели
                                            if (sceneInstance.bet_btn_second) {
                                                sceneInstance.bet_btn_second.updateButtonState(true);
                                                sceneInstance.bet_btn_second.interactive = true;
                                                sceneInstance.bet_btn_second.tint = 0xFFFFFF; // Восстанавливаем оригинальный цвет
                                                sceneInstance.bet_btn_second.alpha = 1.0; // Восстанавливаем яркость
                                            }
                                            
                                            console.log('✅ Кнопки ставок разблокированы');
                                            
                                            // ИСПОЛЬЗУЕМ ВСТРОЕННУЮ ФУНКЦИЮ РАЗБЛОКИРОВКИ ТОЛЬКО В НАЧАЛЕ НОВОГО РАУНДА
                                            if (sceneInstance.enablePanel) {
                                                sceneInstance.enablePanel();
                                                console.log('🔓 Встроенная разблокировка панелей в начале нового раунда');
                                            }
                                        }
                                    }
                                }, 2000); // Задержка 2 секунды для завершения анимации
                                
                                setTimeout(() => {
                                    // Добавляем множитель в историю перед сбросом
                                    if (window.__gameRenderer && window.__gameRenderer.SceneManager) {
                                        const sceneInstance = window.__gameRenderer.SceneManager.getCurrentScene();
                                        if (sceneInstance && sceneInstance.historyText && state.maxMultiplier > 0) {
                                            const multiplierText = state.maxMultiplier.toFixed(2) + "X";
                                            sceneInstance.historyText.unshift(multiplierText);
                                            if (sceneInstance.historyText.length > 6) {
                                                sceneInstance.historyText.pop();
                                            }
                                            if (sceneInstance.writeHistory) {
                                                sceneInstance.writeHistory();
                                            }
                                        }
                                        
                                        // Сбрасываем ставки и разблокируем кнопки
                                        if (sceneInstance) {
                                            // Правильно сбрасываем betData - не undefined, а пустые объекты
                                            sceneInstance.betData = { 
                                                bet1: { stake: 0, autoCashOutMultiplier: 0 }, 
                                                bet2: { stake: 0, autoCashOutMultiplier: 0 } 
                                            };
                                            sceneInstance.isfirstBetActive = false;
                                            sceneInstance.isSecondBetActive = false;
                                            sceneInstance.totalBetAdded_1 = 0;
                                            sceneInstance.totalBetAdded_2 = 0;
                                            
                                            // Разблокируем кнопки ставок
                                            if (sceneInstance.enablePanel) {
                                                sceneInstance.enablePanel();
                                            }
                                            console.log('🔄 Ставки сброшены, кнопки разблокированы');
                                        }
                                    }
                                    
                                    state.phase = 'open'; // Сначала переходим в фазу открытия для сброса состояния
                                    state.endTimer = false;
                                    state.maxMultiplier = 0; // Сбрасываем
                                    state.crashAnimationTime = 0; // Сбрасываем
                                    state.roundId = 'offline_round_' + Date.now(); // Новый ID раунда
                                    console.log('⏳ Подготовка к новому раунду...');
                                    
                                    // Через небольшую задержку переходим в waiting
                                    setTimeout(() => {
                                        state.phase = 'waiting';
                                        state.countdownTime = 10;
                                        console.log('🕐 Начинаем отсчет до нового раунда...');
                                    }, 200);
                                    
                                    // Сбрасываем ставки в игре и состояние
                                    if (window.__gameApp) {
                                        // Сбрасываем флаги состояния игры
                                        if (window.__gameRenderer && window.__gameRenderer.SceneManager) {
                                            const sceneInstance = window.__gameRenderer.SceneManager.getCurrentScene();
                                            if (sceneInstance) {
                                                sceneInstance.isFirstTimeLoad = true;
                                                sceneInstance.loaderStarted = false;
                                                sceneInstance.isRoundCounterStarted = false;
                                            }
                                        }
                                        
                                        // Сначала отправляем событие закрытия раунда для сброса состояния
                                        window.__gameApp.emit('gameInProgress', {
                                            rounds: [{
                                                id: state.roundId,
                                                status: 'open', // Используем 'open' для сброса состояния
                                                currentMultiplier: 0,
                                                maxMultiplier: 0,
                                                timeToStartInSeconds: 0
                                            }]
                                        });
                                        
                                        // Затем через небольшую задержку отправляем getready
                                        setTimeout(() => {
                                            window.__gameApp.emit('gameInProgress', {
                                                rounds: [{
                                                    id: state.roundId,
                                                    status: 'getready',
                                                    currentMultiplier: 1.00,
                                                    maxMultiplier: 0,
                                                    timeToStartInSeconds: 10
                                                }]
                                            });
                                        }, 100);
                                        
                                        console.log('🔄 Подготовка к новому раунду - ставки должны сброситься');
                                    }
                                    
                                    // Переключаем анимацию на idle состояние
                                    if (window.__setAnimationPhase) {
                                        window.__setAnimationPhase('idle');
                                    }
                                    
                                    // Сбрасываем состояние анимаций
                                    if (window.__animationState) {
                                        window.__animationState.spineAnimations = [];
                                        window.__animationState.lastRestart = 0;
                                    }
                                    
                                    // Отправляем событие сброса ставок
                                    setTimeout(() => {
                                        try {
                                            // Событие для сброса UI ставок
                                            const resetBetEvent = {
                                                type: 'resetBets',
                                                rounds: [{
                                                    id: state.roundId,
                                                    status: 'waiting',
                                                    currentMultiplier: 1.00,
                                                    maxMultiplier: 0,
                                                    timeToStartInSeconds: 10
                                                }]
                                            };
                                            
                                            if (window.__gameApp) {
                                                window.__gameApp.emit('gameInProgress', resetBetEvent);
                                                window.__gameApp.emit('resetBets');
                                                window.__gameApp.emit('ROUND_END');
                                                console.log('🔄 Отправлено событие сброса ставок');
                                            }
                                            
                                        } catch (error) {
                                            console.log('⚠️ Ошибка сброса ставок:', error);
                                        }
                                    }, 100);
                                    
                                }, 5000); // Увеличиваем время ожидания до 5 секунд
                            }
                        }
                        
                        // Отправляем правильные события для UI (как ожидает onGameInProgress)
                        if (window.__startGameRounds) {
                            // Логируем только изменения фазы, а не каждый тик
                            if (!ws.__lastLoggedPhase || ws.__lastLoggedPhase !== state.phase) {
                            console.log(`📡 WebSocket мок: ${state.phase} - множитель: ${state.multiplier.toFixed(2)}x`);
                                ws.__lastLoggedPhase = state.phase;
                            }
                            
                            // Логируем множитель реже для активной фазы (каждые 5 секунд)
                            if (state.phase === 'active' && (!ws.__lastMultiplierLog || now - ws.__lastMultiplierLog > 5000)) {
                                // console.log(`📈 Множитель: ${state.multiplier.toFixed(2)}x`); // Отключено для уменьшения логов
                                ws.__lastMultiplierLog = now;
                            }
                            
                            // Правильный формат для onGameInProgress функции
                            let gameEvent = null;
                            
                            if (state.phase === 'countdown' || state.phase === 'waiting') {
                                // Фаза ожидания/отсчета - getready
                                gameEvent = {
                                    rounds: [{
                                        id: state.roundId,
                                        status: 'getready',
                                        currentMultiplier: 1.00, // Показываем базовый множитель
                                        maxMultiplier: 0,
                                        timeToStartInSeconds: state.countdownTime > 0 ? state.countdownTime : 10
                                    }]
                                };
                                
                                // Логируем таймер для отладки
                                if (!ws.__lastCountdownLog || now - ws.__lastCountdownLog > 1000) {
                                    console.log(`⏰ Countdown: осталось ${state.countdownTime} секунд`);
                                    ws.__lastCountdownLog = now;
                                }
                            } else if (state.phase === 'open') {
                                // Фаза открытия - для сброса состояния
                                gameEvent = {
                                    rounds: [{
                                        id: state.roundId,
                                        status: 'open',
                                        currentMultiplier: 0,
                                        maxMultiplier: 0,
                                        timeToStartInSeconds: 0
                                    }]
                                };
                                console.log('🔄 Отправлено событие открытия для сброса состояния');
                                
                                // Логируем обновление countdown каждую секунду
                                if (state.phase === 'countdown' && (!ws.__lastCountdownUIUpdate || (now - ws.__lastCountdownUIUpdate) >= 1000)) {
                                    ws.__lastCountdownUIUpdate = now;
                                    console.log(`⏰ Countdown: осталось ${state.countdownTime} секунд`);
                                    
                                    // Отправляем событие обновления countdown
                                    try {
                                        if (window.__gameApp) {
                                            window.__gameApp.emit('updateCountdown', { timeLeft: state.countdownTime });
                                            window.__gameApp.emit('COUNTDOWN_UPDATE', { timeLeft: state.countdownTime });
                                        }
                                    } catch (error) {
                                        console.log('⚠️ Ошибка обновления countdown UI:', error);
                                    }
                                }
                            } else if (state.phase === 'active') {
                                // Активный раунд - показываем растущий множитель
                                gameEvent = {
                                    rounds: [{
                                        id: state.roundId,
                                        status: 'active',
                                        currentMultiplier: +state.multiplier.toFixed(2),
                                        maxMultiplier: 0,
                                        timeToStartInSeconds: 0
                                    }]
                                };
                                
                                // Проверяем автокеш
                                if (window.__gameRenderer && window.__gameRenderer.SceneManager) {
                                    const sceneInstance = window.__gameRenderer.SceneManager.getCurrentScene();
                                    if (sceneInstance && sceneInstance.betData) {
                                        const currentMultiplier = state.multiplier;
                                        const autoCashOuts = [];
                                        
                                        // Проверяем автокеш для bet1
                                        if (sceneInstance.betData.bet1 && sceneInstance.betData.bet1.autoCashOutMultiplier > 0 && 
                                            currentMultiplier >= sceneInstance.betData.bet1.autoCashOutMultiplier) {
                                            sceneInstance.betData.bet1.autoCashOutMultiplier = 0;
                                            autoCashOuts.push("cash_out_btn");
                                        }
                                        
                                        // Проверяем автокеш для bet2
                                        if (sceneInstance.betData.bet2 && sceneInstance.betData.bet2.autoCashOutMultiplier > 0 && 
                                            currentMultiplier >= sceneInstance.betData.bet2.autoCashOutMultiplier) {
                                            sceneInstance.betData.bet2.autoCashOutMultiplier = 0;
                                            autoCashOuts.push("cash_out_btn_2");
                                        }
                                        
                                        // Выполняем автокеш если нужно
                                        if (autoCashOuts.length > 0) {
                                            console.log(`🤖 Автокеш сработал на множителе: ${currentMultiplier.toFixed(2)}x`);
                                            if (sceneInstance.onCashOutButtonClick) {
                                                sceneInstance.onCashOutButtonClick(autoCashOuts);
                                            }
                                        }
                                    }
                                }
                            } else if (state.phase === 'crash_animation') {
                                // Анимация падения - показываем финальный множитель
                                gameEvent = {
                                    rounds: [{
                                        id: state.roundId,
                                        status: 'ended',
                                        currentMultiplier: +state.maxMultiplier.toFixed(2), // Показываем финальный множитель
                                        maxMultiplier: +state.maxMultiplier.toFixed(2),
                                        timeToStartInSeconds: 0
                                    }]
                                };
                                
                                // Логика сгорания ставок теперь обрабатывается в фазе 'ended' через onGameFinished
                            } else if (state.phase === 'ended') {
                                // Раунд завершен - показываем финальный множитель
                                gameEvent = {
                                    rounds: [{
                                        id: state.roundId,
                                        status: 'ended',
                                        currentMultiplier: +state.maxMultiplier.toFixed(2), // Показываем финальный множитель
                                        maxMultiplier: +state.maxMultiplier.toFixed(2),
                                        timeToStartInSeconds: 0
                                    }]
                                };
                                
                                // onGameFinished уже был вызван при краше, здесь только логика перехода к новому раунду
                            }
                            
                            if (gameEvent) {
                                // Отправляем событие напрямую в игровую логику
                                setTimeout(() => {
                                    // Пытаемся найти и вызвать игровые события
                                    try {
                                        if (window.__gameApp) {
                                            // Отправляем событие через ApplicationBase
                                            window.__gameApp.emit('gameInProgress', gameEvent);
                                            // console.log('📤 Отправлено событие через ApplicationBase'); // Отключено для уменьшения засорения консоли
                                        }
                                        
                                        // Ищем игровую сцену и вызываем onGameInProgress напрямую
                                        if (window.DO && window.DO.RendererScenes && window.DO.RendererScenes.Game) {
                                            const gameScene = window.DO.RendererScenes.Game.BananaGameScene;
                                            if (gameScene && gameScene.prototype && gameScene.prototype.onGameInProgress) {
                                                // Находим активный экземпляр сцены
                                                const sceneInstance = window.__gameRenderer?.SceneManager?.getCurrentScene?.();
                                                if (sceneInstance && sceneInstance.onGameInProgress) {
                                                    sceneInstance.onGameInProgress(gameEvent);
                                                    // console.log('📤 Вызван onGameInProgress напрямую'); // Отключено для уменьшения засорения консоли
                                                    
                                                    // Принудительно обновляем UI множителя с ограничением частоты
                                                    if (sceneInstance.counterText && gameEvent.rounds[0].currentMultiplier > 0) {
                                                        const multiplier = gameEvent.rounds[0].currentMultiplier;
                                                        sceneInstance.counterText.setText(multiplier.toFixed(2) + "X");
                                                        sceneInstance.counterText.visible = true;
                                                    }
                                                    
                                // Принудительно показываем progress_message для активной фазы
                                if (state.phase === 'active' && sceneInstance.progress_message) {
                                    sceneInstance.progress_message.visible = true;
                                }
                                
                                // Показываем кнопки кешаут только если есть активные ставки
                                if (state.phase === 'active') {
                                    // Проверяем, есть ли активные ставки
                                    const hasActiveBet1 = sceneInstance.betData && sceneInstance.betData.bet1 && sceneInstance.betData.bet1.stake > 0;
                                    const hasActiveBet2 = sceneInstance.betData && sceneInstance.betData.bet2 && sceneInstance.betData.bet2.stake > 0;
                                    
                                    // Логируем состояние ставок для отладки (отключено)
                                    // console.log('🎯 Состояние ставок:', { hasActiveBet1, hasActiveBet2, betData: sceneInstance.betData, phase: state.phase });
                                    
                                    // Активируем кнопку кешаута только если есть соответствующая ставка И кешаут еще не был выполнен
                                    if (sceneInstance.cashout_btn_first) {
                                        if (hasActiveBet1 && !sceneInstance.__cashoutExecuted) {
                                            sceneInstance.cashout_btn_first.visible = true;
                                            sceneInstance.cashout_btn_first.updateButtonState(true);
                                            sceneInstance.cashout_btn_first.interactive = true;
                                            sceneInstance.cashout_btn_first.buttonMode = true;
                                            
                                            // Устанавливаем правильный componentId для кнопки кешаута
                                            if (sceneInstance.cashout_btn_first.componentId !== "cash_out_btn") {
                                                sceneInstance.cashout_btn_first.componentId = "cash_out_btn";
                                                // console.log('🔧 Установлен componentId для кнопки кешаута 1:', sceneInstance.cashout_btn_first.componentId);
                                            }
                                            
                                            // Логируем состояние кнопки для отладки (отключено)
                                            // console.log('💰 Кнопка кешаута 1 активирована:', { visible: sceneInstance.cashout_btn_first.visible, interactive: sceneInstance.cashout_btn_first.interactive, buttonMode: sceneInstance.cashout_btn_first.buttonMode, componentId: sceneInstance.cashout_btn_first.componentId || 'не установлен' });
                                            
                                            // Переопределяем onCashOutButtonClick сразу при активации кнопки
                                            if (sceneInstance.onCashOutButtonClick && !sceneInstance.__cashoutOverridden) {
                                                const originalOnCashOutButtonClick = sceneInstance.onCashOutButtonClick;
                                                sceneInstance.onCashOutButtonClick = function(buttonIds) {
                                                    console.log('💰 onCashOutButtonClick вызван с кнопками:', buttonIds);
                                                    console.log('🔍 Текущее состояние флага кешаута:', sceneInstance.__cashoutExecuted);
                                                    console.log('🔍 Текущее состояние раунда:', ws.__roundState ? ws.__roundState.phase : 'не определено');
                                                    
                                                    // Логируем полное состояние игры
                                                    if (window.logGameState) {
                                                        window.logGameState();
                                                    }
                                                    
                                                    // Убираем блокировку кешаута - можно нажимать несколько раз
                                                    console.log('💰 Кешаут разрешен - можно нажимать несколько раз');
                                                    
                                                    // Устанавливаем флаг выполнения кешаута
                                                    sceneInstance.__cashoutExecuted = true;
                                                    console.log('✅ Флаг кешаута установлен');
                                                    
                                                    // Логируем состояние после установки флага
                                                    if (window.logGameState) {
                                                        window.logGameState();
                                                    }
                                                    
                                                    // Устанавливаем флаг в WebSocket моке
                                                    if (ws.__roundState) {
                                                        ws.__roundState.cashoutExecuted = true;
                                                        console.log('✅ Флаг кешаута установлен в WebSocket моке');
                                                    }
                                                    
                                                    // Логируем состояние после установки всех флагов
                                                    if (window.logGameState) {
                                                        window.logGameState();
                                                    }
                                                    
                                                    // Сразу блокируем кнопки кешаута после нажатия
                                                    if (buttonIds.includes('cash_out_btn') && sceneInstance.cashout_btn_first) {
                                                        sceneInstance.cashout_btn_first.updateButtonState(false);
                                                        sceneInstance.cashout_btn_first.interactive = false;
                                                        sceneInstance.cashout_btn_first.buttonMode = false;
                                                        // console.log('🔒 Кнопка кешаута 1 заблокирована после нажатия'); // Отключено для уменьшения логов
                                                    }
                                                    if (buttonIds.includes('cash_out_btn_2') && sceneInstance.cashout_btn_second) {
                                                        sceneInstance.cashout_btn_second.updateButtonState(false);
                                                        sceneInstance.cashout_btn_second.interactive = false;
                                                        sceneInstance.cashout_btn_second.buttonMode = false;
                                                        // console.log('🔒 Кнопка кешаута 2 заблокирована после нажатия'); // Отключено для уменьшения логов
                                                    }
                                                    
                                                    // console.log('💰 Проверяем ApplicationBase:', window.DO && window.DO.Common && window.DO.Common.ApplicationBase); // Отключено для уменьшения логов
                                                    // console.log('💰 Проверяем __gameApp:', window.__gameApp); // Отключено для уменьшения логов
                                                    
                                                    // Проверяем и исправляем ApplicationBase если нужно
                                                    if (window.DO && window.DO.Common && window.DO.Common.ApplicationBase) {
                                                        if (!window.__gameApp) {
                                                            window.__gameApp = window.DO.Common.ApplicationBase.instance;
                                                            // console.log('🔧 Исправлен __gameApp:', window.__gameApp); // Отключено для уменьшения логов
                                                        }
                                                        
                                                        // Перехватываем emit для ApplicationBase.instance
                                                        if (window.DO.Common.ApplicationBase.instance && !window.DO.Common.ApplicationBase.instance.__emitOverridden) {
                                                            const originalEmit = window.DO.Common.ApplicationBase.instance.emit;
                                                            window.DO.Common.ApplicationBase.instance.emit = function(eventName, data) {
                                                                // Логируем только важные события, не gameInProgress и game_other_state
                                                                if (eventName !== 'gameInProgress' && eventName !== 'game_other_state') {
                                                                    console.log('📤 ApplicationBase.emit:', eventName, data);
                                                                }
                                                                if (originalEmit) {
                                                                    return originalEmit.call(this, eventName, data);
                                                                }
                                                            };
                                                            window.DO.Common.ApplicationBase.instance.__emitOverridden = true;
                                                            // console.log('🔧 ApplicationBase.emit перехвачен'); // Отключено для уменьшения логов
                                                        }
                                                    }
                                                    
                                                    if (originalOnCashOutButtonClick) {
                                                        console.log('🔄 Вызываем оригинальный onCashOutButtonClick...');
                                                        const result = originalOnCashOutButtonClick.call(this, buttonIds);
                                                        console.log('💰 onCashOutButtonClick завершен, результат:', result);
                                                        
                                                        // Принудительно показываем WIN после кешаута
                                                        setTimeout(() => {
                                                            const currentMultiplier = ws.__roundState ? ws.__roundState.multiplier : 1.0;
                                                            // Получаем реальную ставку из сцены
                                                            let betAmount = 100.0; // По умолчанию
                                                            if (sceneInstance.betData && sceneInstance.betData.bet1 && sceneInstance.betData.bet1.amount) {
                                                                betAmount = sceneInstance.betData.bet1.amount;
                                                            } else if (sceneInstance.currentBetAmount) {
                                                                betAmount = sceneInstance.currentBetAmount;
                                                            }
                                                            const winAmount = betAmount * currentMultiplier;
                                                            console.log('💰 Принудительно показываем WIN после кешаута:', winAmount, '(ставка:', betAmount, '× множитель:', currentMultiplier, ')');
                                                            
                                                            // Используем глобальную функцию для показа WIN
                                                            if (window.showWin) {
                                                                window.showWin(winAmount);
                                                            }
                                                        }, 500);
                                                        
                                                        return result;
                                                    }
                                                };
                                                sceneInstance.__cashoutOverridden = true;
                                                console.log('🔧 onCashOutButtonClick переопределен');
                                            }
                                            
                                            // Добавляем прямой обработчик событий для отладки
                                            if (sceneInstance.cashout_btn_first.on) {
                                                sceneInstance.cashout_btn_first.on('pointerdown', () => {
                                                    console.log('🖱️ Прямое нажатие на кнопку кешаута');
                                                    
                                                    // Убираем блокировку кешаута - можно нажимать несколько раз
                                                    console.log('💰 Кешаут разрешен - можно нажимать несколько раз');
                                                    
                                                    // Пытаемся вызвать onCashOutButtonClick напрямую
                                                    if (sceneInstance.onCashOutButtonClick) {
                                                        console.log('💰 Вызываем onCashOutButtonClick напрямую');
                                                        // Вызываем нашу перехваченную версию
                                                        sceneInstance.onCashOutButtonClick(['cash_out_btn']);
                                                    }
                                                    
                                                    // Показываем WIN принудительно
                                                    const currentMultiplier = ws.__roundState ? ws.__roundState.multiplier : 1.0;
                                                    // Получаем реальную ставку из сцены
                                                    let betAmount = 100.0; // По умолчанию
                                                    if (sceneInstance.betData && sceneInstance.betData.bet1 && sceneInstance.betData.bet1.amount) {
                                                        betAmount = sceneInstance.betData.bet1.amount;
                                                    } else if (sceneInstance.currentBetAmount) {
                                                        betAmount = sceneInstance.currentBetAmount;
                                                    }
                                                    const winAmount = betAmount * currentMultiplier;
                                                    console.log('💰 Показываем WIN при прямом нажатии:', winAmount, '(ставка:', betAmount, '× множитель:', currentMultiplier, ')');
                                                    
                                                    // Используем глобальную функцию для показа WIN
                                                    if (window.showWin) {
                                                        window.showWin(winAmount);
                                                    }
                                                });
                                            }
                                            
                                            // Показываем текст кешаута
                                            if (sceneInstance.cash_out_btn_text) {
                                                sceneInstance.cash_out_btn_text.visible = true;
                                            }
                                            
                                            // Логируем только при изменении состояния (отключено)
                                            if (!ws.__cashout1Active) {
                                                // console.log('💰 Кнопка кешаута 1 активирована');
                                                ws.__cashout1Active = true;
                                            }
                                        } else if (hasActiveBet1 && sceneInstance.__cashoutExecuted) {
                                            // Кешаут уже был выполнен - блокируем кнопку
                                            sceneInstance.cashout_btn_first.visible = true;
                                            sceneInstance.cashout_btn_first.updateButtonState(false);
                                            sceneInstance.cashout_btn_first.interactive = false;
                                            sceneInstance.cashout_btn_first.buttonMode = false;
                                        } else {
                                            sceneInstance.cashout_btn_first.visible = false;
                                            sceneInstance.cashout_btn_first.updateButtonState(false);
                                            sceneInstance.cashout_btn_first.interactive = false;
                                            sceneInstance.cashout_btn_first.buttonMode = false;
                                            
                                            // Скрываем текст кешаута
                                            if (sceneInstance.cash_out_btn_text) {
                                                sceneInstance.cash_out_btn_text.visible = false;
                                            }
                                            
                                            // Логируем только при изменении состояния
                                            if (ws.__cashout1Active) {
                                                console.log('🔒 Кнопка кешаута 1 заблокирована');
                                                ws.__cashout1Active = false;
                                            }
                                        }
                                    }
                                    
                                    if (sceneInstance.cashout_btn_second) {
                                        if (hasActiveBet2 && !sceneInstance.__cashoutExecuted) {
                                            sceneInstance.cashout_btn_second.visible = true;
                                            sceneInstance.cashout_btn_second.updateButtonState(true);
                                            sceneInstance.cashout_btn_second.interactive = true;
                                            sceneInstance.cashout_btn_second.buttonMode = true;
                                            
                                            // Устанавливаем правильный componentId для кнопки кешаута
                                            if (sceneInstance.cashout_btn_second.componentId !== "cash_out_btn_2") {
                                                sceneInstance.cashout_btn_second.componentId = "cash_out_btn_2";
                                                // console.log('🔧 Установлен componentId для кнопки кешаута 2:', sceneInstance.cashout_btn_second.componentId);
                                            }
                                            
                                            // Показываем текст кешаута
                                            if (sceneInstance.cash_out_btn_2_text) {
                                                sceneInstance.cash_out_btn_2_text.visible = true;
                                            }
                                            
                                            // Логируем только при изменении состояния (отключено)
                                            if (!ws.__cashout2Active) {
                                                // console.log('💰 Кнопка кешаута 2 активирована');
                                                ws.__cashout2Active = true;
                                            }
                                        } else if (hasActiveBet2 && sceneInstance.__cashoutExecuted) {
                                            // Кешаут уже был выполнен - блокируем кнопку
                                            sceneInstance.cashout_btn_second.visible = true;
                                            sceneInstance.cashout_btn_second.updateButtonState(false);
                                            sceneInstance.cashout_btn_second.interactive = false;
                                            sceneInstance.cashout_btn_second.buttonMode = false;
                                        } else {
                                            sceneInstance.cashout_btn_second.visible = false;
                                            sceneInstance.cashout_btn_second.updateButtonState(false);
                                            sceneInstance.cashout_btn_second.interactive = false;
                                            sceneInstance.cashout_btn_second.buttonMode = false;
                                            
                                            // Скрываем текст кешаута
                                            if (sceneInstance.cash_out_btn_2_text) {
                                                sceneInstance.cash_out_btn_2_text.visible = false;
                                            }
                                            
                                            // Логируем только при изменении состояния
                                            if (ws.__cashout2Active) {
                                                console.log('🔒 Кнопка кешаута 2 заблокирована');
                                                ws.__cashout2Active = false;
                                            }
                                        }
                                    }
                                } else {
                                    // В неактивных фазах скрываем кнопки кешаута
                                    if (sceneInstance.cashout_btn_first) {
                                        sceneInstance.cashout_btn_first.visible = false;
                                        sceneInstance.cashout_btn_first.updateButtonState(false);
                                        sceneInstance.cashout_btn_first.interactive = false;
                                        sceneInstance.cashout_btn_first.buttonMode = false;
                                        
                                        // Скрываем текст кешаута
                                        if (sceneInstance.cash_out_btn_text) {
                                            sceneInstance.cash_out_btn_text.visible = false;
                                        }
                                    }
                                    if (sceneInstance.cashout_btn_second) {
                                        sceneInstance.cashout_btn_second.visible = false;
                                        sceneInstance.cashout_btn_second.updateButtonState(false);
                                        sceneInstance.cashout_btn_second.interactive = false;
                                        sceneInstance.cashout_btn_second.buttonMode = false;
                                        
                                        // Скрываем текст кешаута
                                        if (sceneInstance.cash_out_btn_2_text) {
                                            sceneInstance.cash_out_btn_2_text.visible = false;
                                        }
                                    }
                                    // Логируем только при изменении фазы
                                    if (ws.__lastPhase !== state.phase) {
                                        console.log(`🔒 Кнопки кешаута скрыты (фаза: ${state.phase})`);
                                        ws.__lastPhase = state.phase;
                                    }
                                }
                                                    
                                                    // Убираем агрессивное обновление UI элементов - это может вызывать видимые артефакты
                                                }
                                            }
                                        }
                                    } catch (error) {
                                        console.log('⚠️ Не удалось вызвать игровые события напрямую:', error);
                                    }
                                    
                                    // Также отправляем через WebSocket для полноты
                                    ws.onmessage && ws.onmessage({ 
                                        data: JSON.stringify(gameEvent) 
                                    });
                                }, 50);
                            }
                        }
                        
                        // Обновляем каждые 100мс для плавности, но только если соединение активно
                        if (!ws.__closed && ws.__isInitialized) {
                            setTimeout(() => listeners(ws).tick(), 100);
                        }
                    },
                    close: () => {
                        console.log('🔌 WebSocket мок отключен');
                        ws.onclose && ws.onclose({});
                    }
                });

                class MockWebSocket {
                    constructor(url) {
                        console.log('🔌 Создаем WebSocket мок для:', url);
                        this.url = url;
                        this.readyState = 0; // CONNECTING
                        this.__closed = false;
                        this.protocol = '';
                        this.extensions = '';
                        this.__isInitialized = false;
                        
                        // Эмулируем подключение
                        setTimeout(() => { 
                            if (!this.__closed) {
                                this.readyState = 1; // OPEN
                                this.__isInitialized = true;
                                listeners(this).open(); 
                                listeners(this).tick(); 
                            }
                        }, 100);
                    }
                    
                    send(data) { 
                        console.log('📤 WebSocket мок получил:', data);
                        
                        // Защита от таймаутов - отвечаем быстро
                        if (!this.__isInitialized) {
                            console.log('⚠️ WebSocket еще не инициализирован, игнорируем сообщение');
                            return;
                        }
                        
                        // Парсим сообщение один раз
                        let message;
                        try {
                            message = JSON.parse(data);
                        } catch (error) {
                            console.log('❌ Ошибка парсинга WebSocket сообщения:', error);
                            return;
                        }
                        
                        // Отвечаем на ВСЕ сообщения немедленно, чтобы избежать таймаутов
                        const respondImmediately = () => {
                            if (this.__closed || !this.__isInitialized) return;
                            
                            try {
                                const requestId = message.data?.requestId || 'unknown';
                                
                                // Базовый ответ для всех команд
                                let response = {
                                    cmd: message.cmd,
                                    source: message.source || 'testgame',
                                    data: {
                                        requestId: requestId,
                                        success: true
                                    }
                                };
                                
                                // Специфичные ответы для разных команд
                                if (message.cmd === 'systemping') {
                                    response.data.serverTimeInMS = Date.now();
                                    response.data.localTimeInMS = message.data?.localTimeInMS;
                                    
                                    // Отвечаем на systemping немедленно
                                    if (this.onmessage) {
                                        this.onmessage({ data: JSON.stringify(response) });
                                    }
                                    console.log('📤 WebSocket мок отвечает на systemping:', response);
                                    return; // Выходим, не обрабатываем дальше
                                } else if (message.cmd === 'metric') {
                                    // Обработка метрик - просто подтверждаем получение
                                    response.data.success = true;
                                    console.log('📊 WebSocket: Получена метрика:', message.data);
                                } else if (message.cmd === 'SEND_ENTER_COMMON_DRAW_REQUEST') {
                                    // Обработка ставки
                                    console.log('🎲 WebSocket: Обрабатываем ставку:', message);
                                    
                                    // Логируем все доступные константы событий
                                    console.log('🔍 DO.Common.Server в WebSocket:', window.DO && window.DO.Common && window.DO.Common.Server);
                                    if (window.DO && window.DO.Common && window.DO.Common.Server) {
                                        console.log('🔍 Все свойства DO.Common.Server в WebSocket:', Object.keys(window.DO.Common.Server));
                                    }
                                    
                                    // Сбрасываем состояние раунда для новой ставки
                                    if (this.__roundState) {
                                        // Сохраняем настройки автокешаута перед сбросом
                                        let savedAutoCashOut1 = null;
                                        let savedAutoCashOut2 = null;
                                        if (window.__gameRenderer && window.__gameRenderer.SceneManager) {
                                            const sceneInstance = window.__gameRenderer.SceneManager.getCurrentScene();
                                            if (sceneInstance) {
                                                if (sceneInstance.autoCashOutToggle1 && sceneInstance.autoCashOutToggle1.checked) {
                                                    savedAutoCashOut1 = sceneInstance.autoCashOutValue1 || 1.50;
                                                }
                                                if (sceneInstance.autoCashOutToggle2 && sceneInstance.autoCashOutToggle2.checked) {
                                                    savedAutoCashOut2 = sceneInstance.autoCashOutValue2 || 1.50;
                                                }
                                            }
                                        }
                                        
                                        this.__roundState.phase = 'open';
                                        this.__roundState.countdownTime = 10;
                                        this.__roundState.multiplier = 1.00;
                                        this.__roundState.maxMultiplier = 0;
                                        this.__roundState.endTimer = false;
                                        this.__roundState.crashAnimationTime = 0;
                                        this.__roundState.roundId = 'offline_round_' + Date.now();
                                        
                                        // Восстанавливаем настройки автокешаута после сброса
                                        if (savedAutoCashOut1 !== null || savedAutoCashOut2 !== null) {
                                            setTimeout(() => {
                                                if (window.__gameRenderer && window.__gameRenderer.SceneManager) {
                                                    const sceneInstance = window.__gameRenderer.SceneManager.getCurrentScene();
                                                    if (sceneInstance) {
                                                        if (savedAutoCashOut1 !== null && sceneInstance.autoCashOutToggle1) {
                                                            sceneInstance.autoCashOutToggle1.checked = true;
                                                            sceneInstance.autoCashOutValue1 = savedAutoCashOut1;
                                                            console.log('🔄 Восстановлен автокешаут 1:', savedAutoCashOut1);
                                                        }
                                                        if (savedAutoCashOut2 !== null && sceneInstance.autoCashOutToggle2) {
                                                            sceneInstance.autoCashOutToggle2.checked = true;
                                                            sceneInstance.autoCashOutValue2 = savedAutoCashOut2;
                                                            console.log('🔄 Восстановлен автокешаут 2:', savedAutoCashOut2);
                                                        }
                                                    }
                                                }
                                            }, 100);
                                        }
                                        
                                        // Блокируем кнопки ставок
                                        if (window.__gameRenderer && window.__gameRenderer.SceneManager) {
                                            const sceneInstance = window.__gameRenderer.SceneManager.getCurrentScene();
                                            if (sceneInstance) {
                                                console.log('🔒 Блокируем кнопки ставок в WebSocket...');
                                                sceneInstance.__betButtonsBlocked = true;
                                                
                                                // ИСПОЛЬЗУЕМ ВСТРОЕННЫЕ ФУНКЦИИ БЛОКИРОВКИ
                                                if (sceneInstance.disablePanelFirstBetPanel) {
                                                    sceneInstance.disablePanelFirstBetPanel();
                                                    console.log('🔒 WebSocket: Встроенная блокировка первой панели');
                                                }
                                                if (sceneInstance.disablePanelSecondBetPanel) {
                                                    sceneInstance.disablePanelSecondBetPanel();
                                                    console.log('🔒 WebSocket: Встроенная блокировка второй панели');
                                                }
                                                
                                                // Прямая блокировка всех кнопок ставок
                                                const buttonsToBlock = [
                                                    'first_bet_button', 'second_bet_button', 'third_bet_button', 'fourth_bet_button',
                                                    'first_bet_button_2', 'second_bet_button_2', 'third_bet_button_2', 'fourth_bet_button_2',
                                                    'plus_button', 'minus_button', 'plus_button_2', 'minus_button_2',
                                                    'bet_plus_btn', 'bet_minus_btn', 'bet_plus_btn_2', 'bet_minus_btn_2',
                                                    'autoCashOutToggle1', 'autoCashOutToggle2',
                                                    'bet_btn_first', 'bet_btn_second'
                                                ];
                                                
                                                buttonsToBlock.forEach(buttonName => {
                                                    if (sceneInstance[buttonName]) {
                                                        if (sceneInstance[buttonName].updateButtonState) {
                                                            sceneInstance[buttonName].updateButtonState(false);
                                                        }
                                                        sceneInstance[buttonName].interactive = false;
                                                        sceneInstance[buttonName].alpha = 0.5;
                                                        console.log(`🔒 WebSocket заблокирована ${buttonName}`);
                                                    }
                                                });
                                                
                                                if (sceneInstance.disablePanelFirstBetPanel) {
                                                    sceneInstance.disablePanelFirstBetPanel();
                                                }
                                                if (sceneInstance.disablePanelSecondBetPanel) {
                                                    sceneInstance.disablePanelSecondBetPanel();
                                                }
                                                
                                                // Инициализируем текстовые компоненты кешаута
                                                if (sceneInstance.cash_out_btn_text) {
                                                    sceneInstance.cash_out_btn_text.visible = false;
                                                }
                                                if (sceneInstance.cash_out_btn_2_text) {
                                                    sceneInstance.cash_out_btn_2_text.visible = false;
                                                }
                                            }
                                        }
                                        
                                        setTimeout(() => {
                                            this.__roundState.phase = 'waiting';
                                        }, 100);
                                    }
                                    
                                    // Вычитаем ставку из текущего баланса
                                    const betAmount = message.data?.body?.stake || 100;
                                    ws.__currentBalance -= betAmount;
                                    
                                    response.cmd = 'SEND_ENTER_COMMON_DRAW_RESPONSE';
                                    response.data.body = {
                                        success: true,
                                        betId: 'bet_' + Date.now(),
                                        currency: 'EUR',
                                        balance: {
                                            totalBalance: ws.__currentBalance,
                                            currency: 'EUR'
                                        }
                                    };
                                    
                                    console.log(`💰 Ставка ${betAmount} вычтена из баланса. Новый баланс: ${ws.__currentBalance} центов (${(ws.__currentBalance / 100).toFixed(2)} EUR)`);
                                    
                                    // Сохраняем ставку в betData
                                    if (window.__gameRenderer && window.__gameRenderer.SceneManager) {
                                        const sceneInstance = window.__gameRenderer.SceneManager.getCurrentScene();
                                        if (sceneInstance && sceneInstance.betData) {
                                            const betAmount = message.data?.body?.stake || 100;
                                            const betIndex = message.data?.body?.betIndex || 1; // 1 или 2
                                            
                                            if (betIndex === 1) {
                                                sceneInstance.betData.bet1.stake = betAmount;
                                                sceneInstance.isfirstBetActive = true;
                                                sceneInstance.totalBetAdded_1 = betAmount;
                                            } else if (betIndex === 2) {
                                                sceneInstance.betData.bet2.stake = betAmount;
                                                sceneInstance.isSecondBetActive = true;
                                                sceneInstance.totalBetAdded_2 = betAmount;
                                            }
                                            
                                            console.log(`🎯 Ставка ${betIndex}: ${betAmount}`);
                                        }
                                    }
                                    
                                    
                                } else if (message.cmd === 'SEND_CASHOUT_COMMON_DRAW_REQUEST') {
                                    // Обработка кешаута
                                    console.log('💰 WebSocket: Обрабатываем кешаут:', message);
                                    console.log('💰 WebSocket: Структура данных кешаута:', JSON.stringify(message, null, 2));
                                    console.log('💰 WebSocket: Начинаем обработку кешаута...');
                                    
                                    if (this.__roundState && this.__roundState.phase === 'active') {
                                        this.__roundState.phase = 'crash_animation';
                                        this.__roundState.maxMultiplier = this.__roundState.multiplier;
                                        this.__roundState.crashAnimationTime = 0;
                                        
                                        // Сразу вызываем onGameFinished для проигрывания анимации FELL OFF при кешауте
                                        setTimeout(() => {
                                            if (window.__gameRenderer && window.__gameRenderer.SceneManager) {
                                                const sceneInstance = window.__gameRenderer.SceneManager.getCurrentScene();
                                                if (sceneInstance && sceneInstance.onGameFinished) {
                                                    // Создаем объект события окончания игры (с кешаутом)
                                                    const gameFinishedEvent = {
                                                        isCashout: true, // Кешаут - ставки не горят
                                                        result: {
                                                            result: {
                                                                maxMultiplier: this.__roundState.multiplier
                                                            }
                                                        }
                                                    };
                                                    
                                                    console.log('💰 Вызываем onGameFinished для анимации FELL OFF при кешауте');
                                                    sceneInstance.onGameFinished(gameFinishedEvent);
                                                }
                                            }
                                        }, 50);
                                        
                                        // Добавляем в историю
                                        if (window.__gameRenderer && window.__gameRenderer.SceneManager) {
                                            const sceneInstance = window.__gameRenderer.SceneManager.getCurrentScene();
                                            if (sceneInstance && sceneInstance.historyText) {
                                                const multiplierText = this.__roundState.multiplier.toFixed(2) + "X";
                                                sceneInstance.historyText.unshift(multiplierText);
                                                if (sceneInstance.historyText.length > 6) {
                                                    sceneInstance.historyText.pop();
                                                }
                                                if (sceneInstance.writeHistory) {
                                                    sceneInstance.writeHistory();
                                                }
                                            }
                                        }
                                    }
                                    
                                    const currentMultiplier = this.__roundState?.multiplier || 1.25;
                                    
                                    // Получаем данные о ставках из оригинальной структуры
                                    const betData = message.data?.body?.betData || {};
                                    const betTypes = betData.bet || []; // ["bet1"] или ["bet2"] или ["bet1", "bet2"]
                                    
                                    console.log('💰 Обрабатываем кешаут для ставок:', betTypes);
                                    
                                    // Вычисляем общую сумму ставки
                                    let totalBetAmount = 0;
                                    if (window.__gameRenderer && window.__gameRenderer.SceneManager) {
                                        const sceneInstance = window.__gameRenderer.SceneManager.getCurrentScene();
                                        if (sceneInstance && sceneInstance.betData) {
                                            if (betTypes.includes("bet1") && sceneInstance.betData.bet1) {
                                                totalBetAmount += sceneInstance.betData.bet1.stake || 0;
                                            }
                                            if (betTypes.includes("bet2") && sceneInstance.betData.bet2) {
                                                totalBetAmount += sceneInstance.betData.bet2.stake || 0;
                                            }
                                        }
                                    }
                                    
                                    const winAmount = Math.floor(currentMultiplier * totalBetAmount);
                                    
                                    // Добавляем выигрыш к текущему балансу
                                    ws.__currentBalance += winAmount;
                                    
                                    response.cmd = 'SEND_CASHOUT_COMMON_DRAW_RESPONSE';
                                    response.data.body = {
                                        success: true,
                                        currency: 'EUR',
                                        balance: {
                                            totalBalance: ws.__currentBalance,
                                            currency: 'EUR'
                                        },
                                        result: {
                                            win: winAmount,
                                            multiplier: +currentMultiplier.toFixed(2),
                                            cashedOut: true,
                                            betAmount: totalBetAmount
                                        }
                                    };
                                    
                                    // onGameFinished уже был вызван при кешауте, здесь только логика ответа
                                    
                                    console.log(`💰 Кеш-аут: ${currentMultiplier.toFixed(2)}x, выигрыш: ${winAmount} центов (${(winAmount / 100).toFixed(2)} EUR), новый баланс: ${ws.__currentBalance} центов (${(ws.__currentBalance / 100).toFixed(2)} EUR)`);
                                    console.log('💰 Отправляем ответ с балансом:', response.data.body.balance);
                                    
                                    // Отправляем событие кешаута для обработки игрой
                                    setTimeout(() => {
                                        console.log('💰 Отправляем событие кешаута...');
                                        
                                        // Отправляем событие через ApplicationBase
                                        if (window.__gameApp && window.__gameApp.emit) {
                                            const cashoutEventData = {
                                                success: true,
                                                action: 'cashoutCommonDraw',
                                                balance: {
                                                    totalBalance: ws.__currentBalance,
                                                    currency: 'EUR',
                                                    currencyMultiplier: 100
                                                },
                                                result: {
                                                    win: winAmount,
                                                    multiplier: +currentMultiplier.toFixed(2),
                                                    cashedOut: true,
                                                    betAmount: totalBetAmount
                                                },
                                                betOption: {
                                                    bet1: betTypes.includes("bet1"),
                                                    bet2: betTypes.includes("bet2")
                                                }
                                            };
                                            
                                            // Сбрасываем флаг кешаута в WebSocket моке
                                            if (ws.__roundState) {
                                                ws.__roundState.cashoutExecuted = false;
                                                console.log('🔄 Флаг кешаута сброшен в WebSocket моке');
                                            }
                                            
                                            console.log('💰 Отправляем событие RECEIVE_COMMON_DRAW_CASHOUT:', cashoutEventData);
                                            window.__gameApp.emit('RECEIVE_COMMON_DRAW_CASHOUT', cashoutEventData);
                                            
                                            // Разблокируем кнопки ставок после кешаута
                                            setTimeout(() => {
                                                if (window.__gameRenderer && window.__gameRenderer.SceneManager) {
                                                    const sceneInstance = window.__gameRenderer.SceneManager.getCurrentScene();
                                                    if (sceneInstance && sceneInstance.__betButtonsBlocked) {
                                                        console.log('🔓 Разблокируем кнопки ставок после кешаута...');
                                                        sceneInstance.__betButtonsBlocked = false;
                                                        
                                                        // Разблокируем кнопки выбора ставок с восстановлением визуального состояния
                                                        if (sceneInstance.first_bet_button) {
                                                            sceneInstance.first_bet_button.updateButtonState(true);
                                                            sceneInstance.first_bet_button.interactive = true;
                                                            sceneInstance.first_bet_button.alpha = 1.0; // Восстанавливаем яркость
                                                        }
                                                        if (sceneInstance.second_bet_button) {
                                                            sceneInstance.second_bet_button.updateButtonState(true);
                                                            sceneInstance.second_bet_button.interactive = true;
                                                            sceneInstance.second_bet_button.alpha = 1.0; // Восстанавливаем яркость
                                                        }
                                                        if (sceneInstance.third_bet_button) {
                                                            sceneInstance.third_bet_button.updateButtonState(true);
                                                            sceneInstance.third_bet_button.interactive = true;
                                                            sceneInstance.third_bet_button.alpha = 1.0; // Восстанавливаем яркость
                                                        }
                                                        if (sceneInstance.fourth_bet_button) {
                                                            sceneInstance.fourth_bet_button.updateButtonState(true);
                                                            sceneInstance.fourth_bet_button.interactive = true;
                                                            sceneInstance.fourth_bet_button.alpha = 1.0; // Восстанавливаем яркость
                                                        }
                                                        
                                                        // Разблокируем кнопки +/- ставок с восстановлением визуального состояния
                                                        if (sceneInstance.bet_minus_btn) {
                                                            sceneInstance.bet_minus_btn.updateButtonState(true);
                                                            sceneInstance.bet_minus_btn.interactive = true;
                                                            sceneInstance.bet_minus_btn.alpha = 1.0; // Восстанавливаем яркость
                                                        }
                                                        if (sceneInstance.bet_plus_btn) {
                                                            sceneInstance.bet_plus_btn.updateButtonState(true);
                                                            sceneInstance.bet_plus_btn.interactive = true;
                                                            sceneInstance.bet_plus_btn.alpha = 1.0; // Восстанавливаем яркость
                                                        }
                                                        
                                                        // Разблокируем кнопки автокешаута с восстановлением визуального состояния
                                                        if (sceneInstance.autoCashOutToggle1) {
                                                            sceneInstance.autoCashOutToggle1.interactive = true;
                                                            sceneInstance.autoCashOutToggle1.alpha = 1.0; // Восстанавливаем яркость
                                                        }
                                                        
                                                        // Разблокируем кнопку BET
                                                        if (sceneInstance.bet_btn_first) {
                                                            sceneInstance.bet_btn_first.updateButtonState(true);
                                                            sceneInstance.bet_btn_first.interactive = true;
                                                            sceneInstance.bet_btn_first.alpha = 1.0; // Восстанавливаем яркость
                                                        }
                                                        
                                                        // Разблокируем кнопки для второй панели с восстановлением визуального состояния
                                                        if (sceneInstance.first_bet_button_2) {
                                                            sceneInstance.first_bet_button_2.updateButtonState(true);
                                                            sceneInstance.first_bet_button_2.interactive = true;
                                                            sceneInstance.first_bet_button_2.alpha = 1.0; // Восстанавливаем яркость
                                                        }
                                                        if (sceneInstance.second_bet_button_2) {
                                                            sceneInstance.second_bet_button_2.updateButtonState(true);
                                                            sceneInstance.second_bet_button_2.interactive = true;
                                                            sceneInstance.second_bet_button_2.alpha = 1.0; // Восстанавливаем яркость
                                                        }
                                                        if (sceneInstance.third_bet_button_2) {
                                                            sceneInstance.third_bet_button_2.updateButtonState(true);
                                                            sceneInstance.third_bet_button_2.interactive = true;
                                                            sceneInstance.third_bet_button_2.alpha = 1.0; // Восстанавливаем яркость
                                                        }
                                                        if (sceneInstance.fourth_bet_button_2) {
                                                            sceneInstance.fourth_bet_button_2.updateButtonState(true);
                                                            sceneInstance.fourth_bet_button_2.interactive = true;
                                                            sceneInstance.fourth_bet_button_2.alpha = 1.0; // Восстанавливаем яркость
                                                        }
                                                        
                                                        if (sceneInstance.bet_minus_btn_2) {
                                                            sceneInstance.bet_minus_btn_2.updateButtonState(true);
                                                            sceneInstance.bet_minus_btn_2.interactive = true;
                                                            sceneInstance.bet_minus_btn_2.alpha = 1.0; // Восстанавливаем яркость
                                                        }
                                                        if (sceneInstance.bet_plus_btn_2) {
                                                            sceneInstance.bet_plus_btn_2.updateButtonState(true);
                                                            sceneInstance.bet_plus_btn_2.interactive = true;
                                                            sceneInstance.bet_plus_btn_2.alpha = 1.0; // Восстанавливаем яркость
                                                        }
                                                        
                                                        if (sceneInstance.autoCashOutToggle2) {
                                                            sceneInstance.autoCashOutToggle2.interactive = true;
                                                            sceneInstance.autoCashOutToggle2.alpha = 1.0; // Восстанавливаем яркость
                                                        }
                                                        
                                                        // Разблокируем кнопку BET для второй панели
                                                        if (sceneInstance.bet_btn_second) {
                                                            sceneInstance.bet_btn_second.updateButtonState(true);
                                                            sceneInstance.bet_btn_second.interactive = true;
                                                            sceneInstance.bet_btn_second.alpha = 1.0; // Восстанавливаем яркость
                                                        }
                                                        
                                                        console.log('✅ Кнопки ставок разблокированы после кешаута');
                                                        
                                                        // НЕ ВЫЗЫВАЕМ enablePanel после кешаута - это делается только в начале нового раунда
                                                    }
                                                }
                                            }, 1000); // Задержка 1 секунда после кешаута
                                            
                                            // Также пытаемся вызвать handleCommonDrawGameCashout напрямую
                                            if (window.__gameRenderer && window.__gameRenderer.SceneManager) {
                                                const sceneInstance = window.__gameRenderer.SceneManager.getCurrentScene();
                                                if (sceneInstance && sceneInstance.handleCommonDrawGameCashout) {
                                                    console.log('💰 Также вызываем handleCommonDrawGameCashout напрямую');
                                                    try {
                                                        sceneInstance.handleCommonDrawGameCashout(cashoutEventData);
                                                    } catch (error) {
                                                        console.error('💰 Ошибка при вызове handleCommonDrawGameCashout:', error);
                                                    }
                                                }
                                            }
                                        }
                                    }, 100);
                                    
                                    // Сбрасываем ставки после кешаута
                                    setTimeout(() => {
                                        if (window.__gameRenderer && window.__gameRenderer.SceneManager) {
                                            const sceneInstance = window.__gameRenderer.SceneManager.getCurrentScene();
                                            if (sceneInstance && sceneInstance.betData) {
                                                // Сбрасываем ставки
                                                if (betTypes.includes("bet1") && sceneInstance.betData.bet1) {
                                                    sceneInstance.betData.bet1.stake = 0;
                                                    sceneInstance.isfirstBetActive = false;
                                                    sceneInstance.totalBetAdded_1 = 0;
                                                    console.log('💰 Ставка 1 сброшена после кешаута');
                                                }
                                                if (betTypes.includes("bet2") && sceneInstance.betData.bet2) {
                                                    sceneInstance.betData.bet2.stake = 0;
                                                    sceneInstance.isSecondBetActive = false;
                                                    sceneInstance.totalBetAdded_2 = 0;
                                                    console.log('💰 Ставка 2 сброшена после кешаута');
                                                }
                                                
                                                // Дополнительно сбрасываем состояние ставок для всех типов ставок
                                                if (sceneInstance.betData && sceneInstance.betData.bet1) {
                                                    sceneInstance.betData.bet1.stake = 0;
                                                    sceneInstance.isfirstBetActive = false;
                                                    sceneInstance.totalBetAdded_1 = 0;
                                                }
                                                if (sceneInstance.betData && sceneInstance.betData.bet2) {
                                                    sceneInstance.betData.bet2.stake = 0;
                                                    sceneInstance.isSecondBetActive = false;
                                                    sceneInstance.totalBetAdded_2 = 0;
                                                }
                                                
                                                // Обновляем UI ставок
                                                if (sceneInstance.updateBetDisplay) {
                                                    sceneInstance.updateBetDisplay();
                                                }
                                                
                                                // Вызываем enablePanel для сброса состояния кнопок
                                                if (sceneInstance.enablePanel) {
                                                    sceneInstance.enablePanel();
                                                    console.log('💰 Вызван enablePanel для сброса состояния после кешаута');
                                                }
                                                
                                                // Сбрасываем флаг кешаута после завершения раунда
                                                sceneInstance.__cashoutExecuted = false;
                                                console.log('🔄 Флаг кешаута сброшен после завершения раунда');
                                            }
                                        }
                                    }, 100); // Небольшая задержка для завершения анимации
                                    
                                } else if (message.cmd === 'game') {
                                    const operation = message.data?.body?.op || 'unknown';
                                    
                                    if (operation === 'spin' || operation === 'bet') {
                                        // Вычитаем ставку из текущего баланса
                                        const betAmount = message.data?.body?.stake || 100;
                                        ws.__currentBalance -= betAmount;
                                        
                                        response.data.body = {
                                            success: true,
                                            currency: 'EUR',
                                            balance: {
                                                totalBalance: ws.__currentBalance,
                                                currency: 'EUR',
                                                currencyMultiplier: 100
                                            },
                                            result: {
                                                win: 0,
                                                multiplier: 1.00,
                                                betAmount: betAmount
                                            }
                                        };
                                        console.log(`🎯 Ставка принята: ${betAmount}, новый баланс: ${ws.__currentBalance}`);
                                    } else if (operation === 'cashout' || operation === 'cash_out' || operation === 'withdraw') {
                                        const currentMultiplier = this.__roundState?.multiplier || 1.25;
                                        const betAmount = message.data?.body?.betAmount || message.data?.body?.stake || 100;
                                        const winAmount = Math.floor(currentMultiplier * betAmount);
                                        
                                        // Добавляем выигрыш к текущему балансу
                                        ws.__currentBalance += winAmount;
                                        
                                        response.data.body = {
                                            success: true,
                                            currency: 'EUR',
                                            balance: {
                                                totalBalance: ws.__currentBalance,
                                                currency: 'EUR',
                                                currencyMultiplier: 100
                                            },
                                            result: {
                                                win: winAmount,
                                                multiplier: +currentMultiplier.toFixed(2),
                                                cashedOut: true,
                                                betAmount: betAmount
                                            }
                                        };
                                        console.log(`💰 Кеш-аут выполнен: ${currentMultiplier.toFixed(2)}x, выигрыш: ${winAmount}`);
                                    } else if (operation === 'loadConfig') {
                                        response.data.body = {
                                            success: true,
                                            config: {
                                                gameId: 'playzia-bananabonanza',
                                                currency: 'EUR',
                                                minBet: 1,
                                                maxBet: 1000
                                            }
                                        };
                                        console.log('⚙️ Конфигурация загружена');
                                    }
                                }
                                
                                // Отправляем ответ
                                if (response && this.readyState === 1) {
                                    // Вызываем onmessage напрямую, как это делает настоящий WebSocket
                                    if (this.onmessage) {
                                        this.onmessage({ data: JSON.stringify(response) });
                                    }
                                    console.log('📤 WebSocket мок отвечает:', response);
                                }
                                
                            } catch (error) {
                                console.log('⚠️ Ошибка обработки сообщения:', error);
                            }
                        };
                        
                        // Для systemping отвечаем немедленно, для остальных с задержкой
                        if (message.cmd === 'systemping') {
                            respondImmediately();
                        } else {
                            setTimeout(respondImmediately, 10); // Отвечаем очень быстро
                        }
                        
                        // Логирование входящих сообщений
                        console.log('📥 Парсим сообщение:', message);
                    }
                    
                    close(code = 1000, reason = '') { 
                        console.log('🔌 Закрываем WebSocket мок');
                        this.__closed = true; 
                        this.__isInitialized = false;
                        this.readyState = 3; // CLOSED
                        
                        // Очищаем состояние раунда
                        if (this.__roundState) {
                            this.__roundState = null;
                        }
                        
                        listeners(this).close(); 
                    }
                    
                    addEventListener(type, listener, options) {
                        if (type === 'open') this.onopen = listener;
                        if (type === 'message') this.onmessage = listener;
                        if (type === 'close') this.onclose = listener;
                        if (type === 'error') this.onerror = listener;
                    }
                    
                    removeEventListener(type, listener, options) {
                        if (type === 'open') this.onopen = null;
                        if (type === 'message') this.onmessage = null;
                        if (type === 'close') this.onclose = null;
                        if (type === 'error') this.onerror = null;
                    }
                }

                // Константы WebSocket
                MockWebSocket.CONNECTING = 0;
                MockWebSocket.OPEN = 1;
                MockWebSocket.CLOSING = 2;
                MockWebSocket.CLOSED = 3;

                // Перекрываем WebSocket ГЛОБАЛЬНО
                window.WebSocket = MockWebSocket;
                window.MozWebSocket = MockWebSocket; // Для Firefox
                
                console.log('✅ WebSocket мок активирован в игре!');
                
                            // Добавляем команду для ручного переключения анимаций
                            window.__testAnimations = function() {
                                console.log('🧪 Тестируем переключение анимаций...');
                                
                                console.log('1️⃣ Переключаем на idle...');
                                window.__setAnimationPhase('idle');
                                
                                setTimeout(() => {
                                    console.log('2️⃣ Переключаем на rising...');
                                    window.__setAnimationPhase('rising');
                                }, 2000);
                                
                                setTimeout(() => {
                                    console.log('3️⃣ Переключаем на crashed...');
                                    window.__setAnimationPhase('crashed');
                                }, 4000);
                                
                                setTimeout(() => {
                                    console.log('4️⃣ Возвращаем на idle...');
                                    window.__setAnimationPhase('idle');
                                }, 6000);
                            };
                            
                            // Добавляем команду для получения информации о найденных анимациях
                            window.__debugAnimations = function() {
                                console.log('🔍 Информация об анимациях:');
                                console.log('Текущая фаза:', window.__animationState.currentPhase);
                                console.log('Найдено Spine анимаций:', window.__animationState.spineAnimations.length);
                                
                                window.__animationState.spineAnimations.forEach((anim, index) => {
                                    if (anim.skeleton && anim.skeleton.data && anim.skeleton.data.animations) {
                                        const animNames = anim.skeleton.data.animations.map(a => a.name);
                                        console.log(`Анимация ${index}: ${animNames.join(', ')}`);
                                        
                                        // Дополнительная информация о текущем состоянии
                                        if (anim.state && anim.state.tracks && anim.state.tracks.length > 0) {
                                            const currentTrack = anim.state.tracks[0];
                                            if (currentTrack && currentTrack.animation) {
                                                console.log(`  → Текущая анимация: ${currentTrack.animation.name}`);
                                                console.log(`  → Зацикленная: ${currentTrack.loop}`);
                                                console.log(`  → Время: ${currentTrack.trackTime.toFixed(2)}s`);
                                            }
                                        }
                                    }
                                });
                            };
                            
                            // Добавляем функцию для принудительного запуска multiply анимации
                            window.__forceMultiplyAnimation = function() {
                                console.log('🔧 Принудительно запускаем multiply анимацию...');
                                window.__animationState.spineAnimations.forEach((anim, index) => {
                                    if (anim.skeleton && anim.skeleton.data && anim.skeleton.data.animations) {
                                        const multiplyAnim = anim.skeleton.data.animations.find(a => 
                                            a.name.includes('multiply') || a.name.includes('transition')
                                        );
                                        if (multiplyAnim && anim.state) {
                                            anim.state.setAnimation(0, multiplyAnim.name, true);
                                            console.log(`🚀 Запущена ${multiplyAnim.name} для анимации ${index}`);
                                        }
                                    }
                                });
                            };
                            
                            // Добавляем функцию для БЕЗОПАСНОЙ диагностики состояния банана
                            window.__debugBananaVisibility = function() {
                                console.log('🔍 Диагностика видимости банана...');
                                window.__animationState.spineAnimations.forEach((anim, index) => {
                                    try {
                                        console.log(`🍌 Анимация ${index}:`);
                                        console.log(`  → Видимый: ${anim.visible}`);
                                        console.log(`  → Альфа: ${anim.alpha}`);
                                        console.log(`  → Позиция: x=${anim.x}, y=${anim.y}`);
                                        console.log(`  → Масштаб: scaleX=${anim.scale?.x}, scaleY=${anim.scale?.y}`);
                                        
                                        if (anim.state && anim.state.tracks && anim.state.tracks[0]) {
                                            const track = anim.state.tracks[0];
                                            console.log(`  → Текущая анимация: ${track.animation?.name}`);
                                            console.log(`  → Время: ${track.trackTime.toFixed(2)}s`);
                                            console.log(`  → Зацикленная: ${track.loop}`);
                                        }
                                    } catch (e) {
                                        console.log(`⚠️ Ошибка диагностики анимации ${index}:`, e);
                                    }
                                });
                            };
                            
                            // Добавляем функцию для БЕЗОПАСНОГО восстановления банана
                            window.__fixBananaVisibility = function() {
                                console.log('🔧 БЕЗОПАСНО восстанавливаем видимость банана...');
                                window.__animationState.spineAnimations.forEach((anim, index) => {
                                    try {
                                        // Только безопасные изменения
                                        if (anim.visible !== undefined) {
                                            anim.visible = true;
                                        }
                                        if (anim.alpha !== undefined) {
                                            anim.alpha = 1.0;
                                        }
                                        
                                        // Очень осторожно с масштабом
                                        if (anim.scale && anim.scale.x !== undefined && anim.scale.y !== undefined) {
                                            if (anim.scale.x === 0) anim.scale.x = 1.0;
                                            if (anim.scale.y === 0) anim.scale.y = 1.0;
                                        }
                                        
                                        // НЕ ТРОГАЕМ кости - это может повредить transform
                                        console.log(`🍌 Банан ${index} безопасно восстановлен`);
                                    } catch (e) {
                                        console.log(`⚠️ Ошибка восстановления банана ${index}:`, e);
                                    }
                                });
                            };
                            
                            // Экспортируем функции в родительское окно для доступа из консоли
                            if (window.parent && window.parent !== window) {
                                window.parent.__debugBananaVisibility = window.__debugBananaVisibility;
                                window.parent.__fixBananaVisibility = window.__fixBananaVisibility;
                                window.parent.__debugAnimations = window.__debugAnimations;
                                window.parent.__forceMultiplyAnimation = window.__forceMultiplyAnimation;
                                window.parent.__setAnimationPhase = window.__setAnimationPhase;
                                console.log('✅ Диагностические функции экспортированы в родительское окно');
                            }
                
                // Добавляем глобальные команды для диагностики
                window.__debugGame = function() {
                    console.log('🔍 Диагностика игры:');
                    console.log('DO объект:', window.DO);
                    console.log('Game App:', window.__gameApp);
                    console.log('Game Renderer:', window.__gameRenderer);
                    
                    if (window.__gameRenderer && window.__gameRenderer.SceneManager) {
                        const scene = window.__gameRenderer.SceneManager.getCurrentScene();
                        console.log('Текущая сцена:', scene);
                        
                        if (scene && scene.children) {
                            scene.children.forEach((child, i) => {
                                if (child.skeleton && child.skeleton.data) {
                                    console.log(`Spine ${i} анимации:`, 
                                        child.skeleton.data.animations.map(a => a.name)
                                    );
                                }
                            });
                        }
                    }
                };
                
                // Запускаем симуляцию раундов через 2 секунды после загрузки
                setTimeout(() => {
                    console.log('🎲 Запускаем симуляцию раундов...');
                    window.__startGameRounds = true;
                    
                        // Пытаемся найти игровые объекты для прямого управления
                        setTimeout(() => {
                            console.log('🔍 Ищем игровые объекты...');
                            if (window.DO && window.DO.Common && window.DO.Common.ApplicationBase) {
                                console.log('✅ Найден DO.Common.ApplicationBase');
                                window.__gameApp = window.DO.Common.ApplicationBase.instance;
                                
                                // СРАЗУ регистрируем обработчик кешаута
                                if (window.__gameApp && window.__gameApp.on) {
                                    console.log('💰 Регистрируем обработчик кешаута...');
                                    
                                    // Логируем все доступные константы событий
                                    console.log('🔍 DO.Common.Server:', window.DO && window.DO.Common && window.DO.Common.Server);
                                    if (window.DO && window.DO.Common && window.DO.Common.Server) {
                                        console.log('🔍 Все свойства DO.Common.Server:', Object.keys(window.DO.Common.Server));
                                    }
                                    
                                    window.__gameApp.on('SEND_CASHOUT_COMMON_DRAW_REQUEST', (data) => {
                                        console.log('💰 Получен запрос кешаута:', data);
                                        console.log('💰 Event listener: Структура данных кешаута:', JSON.stringify(data, null, 2));
                                        console.log('💰 Event listener: Обрабатываем кешаут...');
                                        
                                        // Обрабатываем кешаут
                                        setTimeout(() => {
                                            if (ws.__roundState && ws.__roundState.phase === 'active') {
                                                const currentMultiplier = ws.__roundState.multiplier;
                                                const betTypes = data.betData?.bet || [];
                                                
                                                // Получаем сумму ставки
                                                let totalBetAmount = 0;
                                                if (window.__gameRenderer && window.__gameRenderer.SceneManager) {
                                                    const sceneInstance = window.__gameRenderer.SceneManager.getCurrentScene();
                                                    if (sceneInstance && sceneInstance.betData) {
                                                        if (betTypes.includes("bet1") && sceneInstance.betData.bet1) {
                                                            totalBetAmount += sceneInstance.betData.bet1.stake || 0;
                                                        }
                                                        if (betTypes.includes("bet2") && sceneInstance.betData.bet2) {
                                                            totalBetAmount += sceneInstance.betData.bet2.stake || 0;
                                                        }
                                                    }
                                                }
                                                
                                                const winAmount = Math.floor(currentMultiplier * totalBetAmount);
                                                
                                                // Добавляем выигрыш к текущему балансу
                                                ws.__currentBalance += winAmount;
                                                
                                                console.log(`💰 Кеш-аут: ${currentMultiplier.toFixed(2)}x, выигрыш: ${winAmount} центов (${(winAmount / 100).toFixed(2)} EUR), новый баланс: ${ws.__currentBalance} центов (${(ws.__currentBalance / 100).toFixed(2)} EUR)`);
                                                
                                                // Отправляем событие кешаута
                                                const cashoutEventData = {
                                                    success: true,
                                                    action: 'cashoutCommonDraw',
                                                    balance: {
                                                        totalBalance: ws.__currentBalance,
                                                        currency: 'EUR',
                                                        currencyMultiplier: 100
                                                    },
                                                    result: {
                                                        win: winAmount,
                                                        multiplier: +currentMultiplier.toFixed(2),
                                                        cashedOut: true,
                                                        betAmount: totalBetAmount
                                                    },
                                                    betOption: {
                                                        bet1: betTypes.includes("bet1"),
                                                        bet2: betTypes.includes("bet2")
                                                    }
                                                };
                                                
                                                console.log('💰 Отправляем событие RECEIVE_COMMON_DRAW_CASHOUT:', cashoutEventData);
                                                window.__gameApp.emit('RECEIVE_COMMON_DRAW_CASHOUT', cashoutEventData);
                                                
                                                // Вызываем handleCommonDrawGameCashout напрямую
                                                if (window.__gameRenderer && window.__gameRenderer.SceneManager) {
                                                    const sceneInstance = window.__gameRenderer.SceneManager.getCurrentScene();
                                                    console.log('💰 sceneInstance для handleCommonDrawGameCashout:', sceneInstance);
                                                    console.log('💰 handleCommonDrawGameCashout функция:', sceneInstance && sceneInstance.handleCommonDrawGameCashout);
                                                    
                                                    if (sceneInstance && sceneInstance.handleCommonDrawGameCashout) {
                                                        console.log('💰 Вызываем handleCommonDrawGameCashout напрямую с данными:', cashoutEventData);
                                                        try {
                                                            const result = sceneInstance.handleCommonDrawGameCashout(cashoutEventData);
                                                            console.log('💰 handleCommonDrawGameCashout вернул:', result);
                                                        } catch (error) {
                                                            console.error('💰 Ошибка при вызове handleCommonDrawGameCashout:', error);
                                                        }
                                                    } else {
                                                        console.log('💰 handleCommonDrawGameCashout недоступен!');
                                                        console.log('💰 Доступные методы sceneInstance:', sceneInstance ? Object.getOwnPropertyNames(sceneInstance) : 'sceneInstance is null');
                                                    }
                                                } else {
                                                    console.log('💰 SceneManager недоступен для handleCommonDrawGameCashout');
                                                }
                                                
                                                // Альтернативный способ обновления баланса через DOM
                                                console.log('💰 Пытаемся обновить баланс через DOM...');
                                                const balanceElements = [
                                                    '#cp_balance',
                                                    '.balance',
                                                    '[data-balance]',
                                                    '.total-balance',
                                                    '#balance',
                                                    '.current-balance'
                                                ];
                                                
                                                let balanceUpdated = false;
                                                balanceElements.forEach(selector => {
                                                    const element = document.querySelector(selector);
                                                    if (element) {
                                                        const newBalance = (ws.__currentBalance / 100).toFixed(2);
                                                        element.textContent = newBalance;
                                                        console.log(`💰 Обновлен баланс в ${selector}: ${newBalance}`);
                                                        balanceUpdated = true;
                                                    }
                                                });
                                                
                                                if (!balanceUpdated) {
                                                    console.log('💰 Не найдены элементы баланса для обновления');
                                                    console.log('💰 Доступные элементы с текстом "balance":', 
                                                        Array.from(document.querySelectorAll('*')).filter(el => 
                                                            el.textContent && el.textContent.toLowerCase().includes('balance')
                                                        ).map(el => ({ tag: el.tagName, text: el.textContent.trim().substring(0, 50) }))
                                                    );
                                                }
                                                
                                                // Пытаемся показать WIN через DOM
                                                console.log('💰 Пытаемся показать WIN через DOM...');
                                                const winElements = [
                                                    '#cp_win',
                                                    '.win-popup',
                                                    '.win-message',
                                                    '[data-win]',
                                                    '.win-amount'
                                                ];
                                                
                                                let winShown = false;
                                                winElements.forEach(selector => {
                                                    const element = document.querySelector(selector);
                                                    if (element) {
                                                        const winAmountDisplay = (winAmount / 100).toFixed(2);
                                                        element.textContent = winAmountDisplay;
                                                        element.style.display = 'block';
                                                        element.style.visibility = 'visible';
                                                        console.log(`💰 Показан WIN в ${selector}: ${winAmountDisplay}`);
                                                        winShown = true;
                                                    }
                                                });
                                                
                                                if (!winShown) {
                                                    console.log('💰 Не найдены элементы WIN для отображения');
                                                }
                                            }
                                        }, 100);
                                    });
                                }
                                
                                    // Перехватываем события ставок и кешаута
                                    if (window.__gameApp && window.__gameApp.on) {
                                        console.log('🎯 Настраиваем перехват игровых событий...');
                                        
                                        // Принудительно сбрасываем флаги состояния игры
                                        if (window.__gameRenderer && window.__gameRenderer.SceneManager) {
                                            const sceneInstance = window.__gameRenderer.SceneManager.getCurrentScene();
                                            if (sceneInstance) {
                                                // Сбрасываем флаги для правильного отображения progress_message
                                                sceneInstance.isFirstTimeLoad = true;
                                                sceneInstance.loaderStarted = false;
                                                sceneInstance.isRoundCounterStarted = false;
                                                
                                                // Инициализируем betData если не существует
                                                if (!sceneInstance.betData) {
                                                    sceneInstance.betData = { 
                                                        bet1: { stake: 0, autoCashOutMultiplier: 0 }, 
                                                        bet2: { stake: 0, autoCashOutMultiplier: 0 } 
                                                    };
                                                }
                                                
                                                // Инициализируем текстовые компоненты кешаута
                                                if (sceneInstance.cash_out_btn_text) {
                                                    sceneInstance.cash_out_btn_text.visible = false;
                                                }
                                                if (sceneInstance.cash_out_btn_2_text) {
                                                    sceneInstance.cash_out_btn_2_text.visible = false;
                                                }
                                                
                                                console.log('🔄 Сброшены флаги состояния игры для правильного отображения UI');
                                            }
                                        }
                                        
                                        // Исправляем проблему с иконкой звука
                                        const fixAudioButton = () => {
                                            const audioButton = document.querySelector('#button_audio');
                                            const audioButtonScreen = document.querySelector('#button_audio_screen');
                                            if (audioButton) {
                                                audioButton.style.display = 'block';
                                                audioButton.style.visibility = 'visible';
                                                audioButton.style.opacity = '1';
                                                audioButton.style.pointerEvents = 'all';
                                            }
                                            if (audioButtonScreen) {
                                                audioButtonScreen.style.display = 'block';
                                                audioButtonScreen.style.visibility = 'visible';
                                                audioButtonScreen.style.opacity = '1';
                                                audioButtonScreen.style.pointerEvents = 'all';
                                            }
                                        };
                                        
                                        // Исправляем сразу и через интервалы (без логирования)
                                        fixAudioButton();
                                        setTimeout(fixAudioButton, 1000);
                                        setTimeout(fixAudioButton, 3000);
                                        setInterval(fixAudioButton, 5000);
                                        console.log('🔊 Исправление иконки звука настроено');
                                        
                                        // Добавляем логирование для кнопок ставок и кешаута
                                        const addButtonLogging = () => {
                                            console.log('🔧 addButtonLogging вызвана');
                                            if (window.__gameRenderer && window.__gameRenderer.SceneManager) {
                                                const sceneInstance = window.__gameRenderer.SceneManager.getCurrentScene();
                                                if (sceneInstance) {
                                                    // Логирование для кнопок ставок (включено для отладки)
                                                    console.log('🔍 Проверяем кнопки ставок...');
                                                    console.log('🔍 bet_btn_first:', sceneInstance.bet_btn_first);
                                                    console.log('🔍 bet_btn_second:', sceneInstance.bet_btn_second);
                                                    
                                                    if (sceneInstance.bet_btn_first) {
                                                        // Добавляем прямую обработку клика по кнопке BET
                                                        const blockAllButtons = () => {
                                                            try {
                                                                console.log('🎲 Прямой клик по bet_btn_first!');
                                                                // НЕ БЛОКИРУЕМ СРАЗУ - только логируем
                                                                console.log('🔍 Клик зафиксирован, блокировка будет после оригинальной функции');
                                                                
                                                                // Устанавливаем флаг что нужно заблокировать после оригинальной функции
                                                                sceneInstance.__needBlockAfterOriginal = true;
                                                            } catch (error) {
                                                                console.log('⚠️ Ошибка в blockAllButtons:', error);
                                                            }
                                                        };
                                                        
                                                        // АГРЕССИВНАЯ БЛОКИРОВКА - добавляем ВСЕ возможные события
                                                        sceneInstance.bet_btn_first.on('pointerdown', blockAllButtons);
                                                        sceneInstance.bet_btn_first.on('pointerup', blockAllButtons);
                                                        sceneInstance.bet_btn_first.on('click', blockAllButtons);
                                                        sceneInstance.bet_btn_first.on('tap', blockAllButtons);
                                                        sceneInstance.bet_btn_first.on('touchstart', blockAllButtons);
                                                        sceneInstance.bet_btn_first.on('touchend', blockAllButtons);
                                                        sceneInstance.bet_btn_first.on('mousedown', blockAllButtons);
                                                        sceneInstance.bet_btn_first.on('mouseup', blockAllButtons);
                                                        
                                                        // ДОПОЛНИТЕЛЬНО - перехватываем все события через addEventListener
                                                        if (sceneInstance.bet_btn_first.element) {
                                                            sceneInstance.bet_btn_first.element.addEventListener('click', blockAllButtons);
                                                            sceneInstance.bet_btn_first.element.addEventListener('mousedown', blockAllButtons);
                                                            sceneInstance.bet_btn_first.element.addEventListener('touchstart', blockAllButtons);
                                                        }
                                                        
                                                        console.log('✅ АГРЕССИВНЫЕ обработчики привязаны к bet_btn_first');
                                                        
                                                        // ГЛОБАЛЬНЫЙ ПЕРЕХВАТЧИК - блокируем при любом взаимодействии с кнопками ставок
                                                        const globalBlockHandler = (event) => {
                                                            try {
                                                                if (event.target && event.target.textContent) {
                                                                    const text = event.target.textContent;
                                                                    if (text.includes('10.00') || text.includes('20.00') || 
                                                                        text.includes('50.00') || text.includes('100.00') || 
                                                                        text.includes('BET')) {
                                                                        console.log('🌐 ГЛОБАЛЬНЫЙ ПЕРЕХВАТЧИК: блокируем кнопку ставки!');
                                                                        blockAllButtons();
                                                                    }
                                                                }
                                                            } catch (error) {
                                                                console.log('⚠️ Ошибка в глобальном перехватчике:', error);
                                                            }
                                                        };
                                                        
                                                        // Добавляем глобальный обработчик с задержкой
                                                        setTimeout(() => {
                                                            document.addEventListener('click', globalBlockHandler);
                                                            document.addEventListener('mousedown', globalBlockHandler);
                                                            document.addEventListener('touchstart', globalBlockHandler);
                                                        }, 1000);
                                                        
                                                        const originalBetClick1 = sceneInstance.onBetButtonClick;
                                                        sceneInstance.onBetButtonClick = function(buttonId) {
                                                            console.log('🎲 onBetButtonClick вызван с buttonId:', buttonId);
                                                            
                                                            // СНАЧАЛА ВЫЗЫВАЕМ ОРИГИНАЛЬНУЮ ФУНКЦИЮ
                                                            if (originalBetClick1) {
                                                                console.log('🔄 Вызываем оригинальную onBetButtonClick СНАЧАЛА');
                                                                const result = originalBetClick1.call(this, buttonId);
                                                                
                                                                // ПОТОМ БЛОКИРУЕМ КНОПКИ С ЗАДЕРЖКОЙ
                                                                setTimeout(() => {
                                                                    console.log('🔒 Блокируем кнопки ставок ПОСЛЕ оригинальной функции...');
                                                                    sceneInstance.__betButtonsBlocked = true;
                                                                    
                                                                    // Блокируем кнопку BET как в оригинале
                                                                    if (sceneInstance.bet_btn_first) {
                                                                        sceneInstance.bet_btn_first.updateButtonState(false);
                                                                        console.log('🔒 bet_btn_first заблокирована');
                                                                    }
                                                                    
                                                                    // Блокируем панель как в оригинале
                                                                    if (sceneInstance.disablePanelFirstBetPanel) {
                                                                        sceneInstance.disablePanelFirstBetPanel();
                                                                        console.log('🔒 disablePanelFirstBetPanel вызван');
                                                                    }
                                                                    
                                                                    // ДОПОЛНИТЕЛЬНАЯ ПРИНУДИТЕЛЬНАЯ БЛОКИРОВКА ВСЕХ КНОПОК
                                                                    const allButtons = [
                                                                        'first_bet_button', 'second_bet_button', 'third_bet_button', 'fourth_bet_button',
                                                                        'first_bet_button_2', 'second_bet_button_2', 'third_bet_button_2', 'fourth_bet_button_2',
                                                                        'plus_button', 'minus_button', 'plus_button_2', 'minus_button_2',
                                                                        'bet_plus_btn', 'bet_minus_btn', 'bet_plus_btn_2', 'bet_minus_btn_2',
                                                                        'autoCashOutToggle1', 'autoCashOutToggle2',
                                                                        'bet_btn_first', 'bet_btn_second'
                                                                    ];
                                                                    
                                                                    allButtons.forEach(buttonName => {
                                                                        if (sceneInstance[buttonName]) {
                                                                            sceneInstance[buttonName].interactive = false;
                                                                            // Делаем кнопки серыми, а не бесцветными
                                                                            sceneInstance[buttonName].tint = 0x808080; // Серый цвет
                                                                            sceneInstance[buttonName].alpha = 1.0; // Полная непрозрачность
                                                                            console.log(`🔒 Заблокирована ${buttonName} (серый цвет)`);
                                                                        }
                                                                    });
                                                                    
                                                                    console.log('🔒 ВСЕ КНОПКИ ПРИНУДИТЕЛЬНО ЗАБЛОКИРОВАНЫ ПОСЛЕ ОРИГИНАЛЬНОЙ ФУНКЦИИ!');
                                                                }, 100); // Задержка 100мс
                                                                
                                                                return result;
                                                            } else {
                                                                console.log('❌ Оригинальная onBetButtonClick не найдена');
                                                            }
                                                            
                                                            // ДУБЛИРУЮЩИЙ КОД УДАЛЕН - блокировка уже происходит выше
                                                            // Блокируем кнопки выбора ставок с визуальной блокировкой
                                                            if (sceneInstance.first_bet_button) {
                                                                sceneInstance.first_bet_button.updateButtonState(false);
                                                                sceneInstance.first_bet_button.interactive = false;
                                                                sceneInstance.first_bet_button.alpha = 0.5; // Делаем серыми
                                                                console.log('🔒 Заблокирована first_bet_button');
                                                            }
                                                            if (sceneInstance.second_bet_button) {
                                                                sceneInstance.second_bet_button.updateButtonState(false);
                                                                sceneInstance.second_bet_button.interactive = false;
                                                                sceneInstance.second_bet_button.alpha = 0.5; // Делаем серыми
                                                                console.log('🔒 Заблокирована second_bet_button');
                                                            }
                                                            if (sceneInstance.third_bet_button) {
                                                                sceneInstance.third_bet_button.updateButtonState(false);
                                                                sceneInstance.third_bet_button.interactive = false;
                                                                sceneInstance.third_bet_button.alpha = 0.5; // Делаем серыми
                                                                console.log('🔒 Заблокирована third_bet_button');
                                                            }
                                                            
                                                            // Блокируем кнопки +/- для изменения ставки
                                                            if (sceneInstance.plus_button) {
                                                                sceneInstance.plus_button.interactive = false;
                                                                sceneInstance.plus_button.alpha = 0.5;
                                                                console.log('🔒 Заблокирована plus_button');
                                                            }
                                                            if (sceneInstance.minus_button) {
                                                                sceneInstance.minus_button.interactive = false;
                                                                sceneInstance.minus_button.alpha = 0.5;
                                                                console.log('🔒 Заблокирована minus_button');
                                                            }
                                                            
                                                            // Блокируем автокешаут
                                                            if (sceneInstance.autoCashOutToggle1) {
                                                                sceneInstance.autoCashOutToggle1.interactive = false;
                                                                sceneInstance.autoCashOutToggle1.alpha = 0.5;
                                                                console.log('🔒 Заблокирован autoCashOutToggle1');
                                                            }
                                                            
                                                            // Блокируем основную кнопку BET
                                                            if (sceneInstance.bet_btn_first) {
                                                                sceneInstance.bet_btn_first.interactive = false;
                                                                sceneInstance.bet_btn_first.alpha = 0.5;
                                                                console.log('🔒 Заблокирована bet_btn_first');
                                                            }
                                                            if (sceneInstance.fourth_bet_button) {
                                                                sceneInstance.fourth_bet_button.updateButtonState(false);
                                                                sceneInstance.fourth_bet_button.interactive = false;
                                                                sceneInstance.fourth_bet_button.alpha = 0.5; // Делаем серыми
                                                            }
                                                            
                                                            // Блокируем кнопки +/- ставок с визуальной блокировкой
                                                            if (sceneInstance.bet_minus_btn) {
                                                                sceneInstance.bet_minus_btn.updateButtonState(false);
                                                                sceneInstance.bet_minus_btn.interactive = false;
                                                                sceneInstance.bet_minus_btn.alpha = 0.5; // Делаем серыми
                                                            }
                                                            if (sceneInstance.bet_plus_btn) {
                                                                sceneInstance.bet_plus_btn.updateButtonState(false);
                                                                sceneInstance.bet_plus_btn.interactive = false;
                                                                sceneInstance.bet_plus_btn.alpha = 0.5; // Делаем серыми
                                                            }
                                                            
                                                            // Блокируем кнопки автокешаута с визуальной блокировкой
                                                            if (sceneInstance.autoCashOutToggle1) {
                                                                sceneInstance.autoCashOutToggle1.interactive = false;
                                                                sceneInstance.autoCashOutToggle1.alpha = 0.3; // Делаем очень серыми
                                                            }
                                                            
                                                            // Блокируем кнопку BET
                                                            if (sceneInstance.bet_btn_first) {
                                                                sceneInstance.bet_btn_first.updateButtonState(false);
                                                                sceneInstance.bet_btn_first.interactive = false;
                                                                sceneInstance.bet_btn_first.alpha = 0.5; // Делаем серыми
                                                            }
                                                            
                                                            console.log('✅ Кнопки ставок заблокированы');
                                                            
                                                            if (originalBetClick1) {
                                                                console.log('🔄 Вызываем оригинальную onBetButtonClick');
                                                                return originalBetClick1.call(this, buttonId);
                                                            } else {
                                                                console.log('❌ Оригинальная onBetButtonClick не найдена');
                                                            }
                                                        };
                                                    }
                                                    
                                                    if (sceneInstance.bet_btn_second) {
                                                        // Добавляем прямую обработку клика по кнопке BET
                                                        const blockAllButtons2 = () => {
                                                            try {
                                                                console.log('🎲 Прямой клик по bet_btn_second!');
                                                                // НЕ БЛОКИРУЕМ СРАЗУ - только логируем
                                                                console.log('🔍 Клик зафиксирован, блокировка будет после оригинальной функции');
                                                                
                                                                // Устанавливаем флаг что нужно заблокировать после оригинальной функции
                                                                sceneInstance.__needBlockAfterOriginal = true;
                                                            } catch (error) {
                                                                console.log('⚠️ Ошибка в blockAllButtons2:', error);
                                                            }
                                                        };
                                                        
                                                        // АГРЕССИВНАЯ БЛОКИРОВКА - добавляем ВСЕ возможные события
                                                        sceneInstance.bet_btn_second.on('pointerdown', blockAllButtons2);
                                                        sceneInstance.bet_btn_second.on('pointerup', blockAllButtons2);
                                                        sceneInstance.bet_btn_second.on('click', blockAllButtons2);
                                                        sceneInstance.bet_btn_second.on('tap', blockAllButtons2);
                                                        sceneInstance.bet_btn_second.on('touchstart', blockAllButtons2);
                                                        sceneInstance.bet_btn_second.on('touchend', blockAllButtons2);
                                                        sceneInstance.bet_btn_second.on('mousedown', blockAllButtons2);
                                                        sceneInstance.bet_btn_second.on('mouseup', blockAllButtons2);
                                                        
                                                        // ДОПОЛНИТЕЛЬНО - перехватываем все события через addEventListener
                                                        if (sceneInstance.bet_btn_second.element) {
                                                            sceneInstance.bet_btn_second.element.addEventListener('click', blockAllButtons2);
                                                            sceneInstance.bet_btn_second.element.addEventListener('mousedown', blockAllButtons2);
                                                            sceneInstance.bet_btn_second.element.addEventListener('touchstart', blockAllButtons2);
                                                        }
                                                        
                                                        console.log('✅ АГРЕССИВНЫЕ обработчики привязаны к bet_btn_second');
                                                        
                                                        const originalBetClick2 = sceneInstance.onBetButtonClick;
                                                        sceneInstance.onBetButtonClick = function(buttonId) {
                                                            console.log('🎲 Ставка 2:', buttonId);
                                                            
                                                            // СНАЧАЛА ВЫЗЫВАЕМ ОРИГИНАЛЬНУЮ ФУНКЦИЮ
                                                            if (originalBetClick2) {
                                                                console.log('🔄 Вызываем оригинальную onBetButtonClick СНАЧАЛА');
                                                                const result = originalBetClick2.call(this, buttonId);
                                                                
                                                                // ПОТОМ БЛОКИРУЕМ КНОПКИ С ЗАДЕРЖКОЙ
                                                                setTimeout(() => {
                                                                    console.log('🔒 Блокируем кнопки ставок ПОСЛЕ оригинальной функции...');
                                                                    sceneInstance.__betButtonsBlocked = true;
                                                                    
                                                                    // Блокируем кнопку BET как в оригинале
                                                                    if (sceneInstance.bet_btn_second) {
                                                                        sceneInstance.bet_btn_second.updateButtonState(false);
                                                                        console.log('🔒 bet_btn_second заблокирована');
                                                                    }
                                                                    
                                                                    // Блокируем панель как в оригинале
                                                                    if (sceneInstance.disablePanelSecondBetPanel) {
                                                                        sceneInstance.disablePanelSecondBetPanel();
                                                                        console.log('🔒 disablePanelSecondBetPanel вызван');
                                                                    }
                                                                    
                                                                    // ДОПОЛНИТЕЛЬНАЯ ПРИНУДИТЕЛЬНАЯ БЛОКИРОВКА ВСЕХ КНОПОК
                                                                    const allButtons = [
                                                                        'first_bet_button', 'second_bet_button', 'third_bet_button', 'fourth_bet_button',
                                                                        'first_bet_button_2', 'second_bet_button_2', 'third_bet_button_2', 'fourth_bet_button_2',
                                                                        'plus_button', 'minus_button', 'plus_button_2', 'minus_button_2',
                                                                        'bet_plus_btn', 'bet_minus_btn', 'bet_plus_btn_2', 'bet_minus_btn_2',
                                                                        'autoCashOutToggle1', 'autoCashOutToggle2',
                                                                        'bet_btn_first', 'bet_btn_second'
                                                                    ];
                                                                    
                                                                    allButtons.forEach(buttonName => {
                                                                        if (sceneInstance[buttonName]) {
                                                                            sceneInstance[buttonName].interactive = false;
                                                                            // Делаем кнопки серыми, а не бесцветными
                                                                            sceneInstance[buttonName].tint = 0x808080; // Серый цвет
                                                                            sceneInstance[buttonName].alpha = 1.0; // Полная непрозрачность
                                                                            console.log(`🔒 Заблокирована ${buttonName} (серый цвет)`);
                                                                        }
                                                                    });
                                                                    
                                                                    console.log('🔒 ВСЕ КНОПКИ ПРИНУДИТЕЛЬНО ЗАБЛОКИРОВАНЫ ПОСЛЕ ОРИГИНАЛЬНОЙ ФУНКЦИИ!');
                                                                }, 100); // Задержка 100мс
                                                                
                                                                return result;
                                                            } else {
                                                                console.log('❌ Оригинальная onBetButtonClick не найдена');
                                                            }
                                                            
                                                            // Блокируем кнопки выбора ставок для второй панели с визуальной блокировкой
                                                            if (sceneInstance.first_bet_button_2) {
                                                                sceneInstance.first_bet_button_2.updateButtonState(false);
                                                                sceneInstance.first_bet_button_2.interactive = false;
                                                                sceneInstance.first_bet_button_2.alpha = 0.5; // Делаем серыми
                                                                console.log('🔒 Заблокирована first_bet_button_2');
                                                            }
                                                            if (sceneInstance.second_bet_button_2) {
                                                                sceneInstance.second_bet_button_2.updateButtonState(false);
                                                                sceneInstance.second_bet_button_2.interactive = false;
                                                                sceneInstance.second_bet_button_2.alpha = 0.5; // Делаем серыми
                                                                console.log('🔒 Заблокирована second_bet_button_2');
                                                            }
                                                            if (sceneInstance.third_bet_button_2) {
                                                                sceneInstance.third_bet_button_2.updateButtonState(false);
                                                                sceneInstance.third_bet_button_2.interactive = false;
                                                                sceneInstance.third_bet_button_2.alpha = 0.5; // Делаем серыми
                                                                console.log('🔒 Заблокирована third_bet_button_2');
                                                            }
                                                            
                                                            // Блокируем кнопки +/- для второй панели
                                                            if (sceneInstance.plus_button_2) {
                                                                sceneInstance.plus_button_2.interactive = false;
                                                                sceneInstance.plus_button_2.alpha = 0.5;
                                                                console.log('🔒 Заблокирована plus_button_2');
                                                            }
                                                            if (sceneInstance.minus_button_2) {
                                                                sceneInstance.minus_button_2.interactive = false;
                                                                sceneInstance.minus_button_2.alpha = 0.5;
                                                                console.log('🔒 Заблокирована minus_button_2');
                                                            }
                                                            
                                                            // Блокируем автокешаут для второй панели
                                                            if (sceneInstance.autoCashOutToggle2) {
                                                                sceneInstance.autoCashOutToggle2.interactive = false;
                                                                sceneInstance.autoCashOutToggle2.alpha = 0.5;
                                                                console.log('🔒 Заблокирован autoCashOutToggle2');
                                                            }
                                                            
                                                            // Блокируем основную кнопку BET для второй панели
                                                            if (sceneInstance.bet_btn_second) {
                                                                sceneInstance.bet_btn_second.interactive = false;
                                                                sceneInstance.bet_btn_second.alpha = 0.5;
                                                                console.log('🔒 Заблокирована bet_btn_second');
                                                            }
                                                            if (sceneInstance.fourth_bet_button_2) {
                                                                sceneInstance.fourth_bet_button_2.updateButtonState(false);
                                                                sceneInstance.fourth_bet_button_2.interactive = false;
                                                                sceneInstance.fourth_bet_button_2.alpha = 0.5; // Делаем серыми
                                                            }
                                                            
                                                            // Блокируем кнопки +/- ставок для второй панели с визуальной блокировкой
                                                            if (sceneInstance.bet_minus_btn_2) {
                                                                sceneInstance.bet_minus_btn_2.updateButtonState(false);
                                                                sceneInstance.bet_minus_btn_2.interactive = false;
                                                                sceneInstance.bet_minus_btn_2.alpha = 0.5; // Делаем серыми
                                                            }
                                                            if (sceneInstance.bet_plus_btn_2) {
                                                                sceneInstance.bet_plus_btn_2.updateButtonState(false);
                                                                sceneInstance.bet_plus_btn_2.interactive = false;
                                                                sceneInstance.bet_plus_btn_2.alpha = 0.5; // Делаем серыми
                                                            }
                                                            
                                                            // Блокируем кнопки автокешаута для второй панели с визуальной блокировкой
                                                            if (sceneInstance.autoCashOutToggle2) {
                                                                sceneInstance.autoCashOutToggle2.interactive = false;
                                                                sceneInstance.autoCashOutToggle2.alpha = 0.3; // Делаем очень серыми
                                                            }
                                                            
                                                            // Блокируем кнопку BET для второй панели
                                                            if (sceneInstance.bet_btn_second) {
                                                                sceneInstance.bet_btn_second.updateButtonState(false);
                                                                sceneInstance.bet_btn_second.interactive = false;
                                                                sceneInstance.bet_btn_second.alpha = 0.5; // Делаем серыми
                                                            }
                                                            
                                                            console.log('✅ Кнопки ставок заблокированы');
                                                            
                                                            if (originalBetClick2) {
                                                                return originalBetClick2.call(this, buttonId);
                                                            }
                                                        };
                                                    }
                                                    
                                                    // Логирование для кнопок кешаута (отключено)
                                                    // if (sceneInstance.cashout_btn_first) {
                                                    //     const originalCashoutClick1 = sceneInstance.onCashOutButtonClick;
                                                    //     sceneInstance.onCashOutButtonClick = function(buttonIds) {
                                                    //         console.log('💰 Кешаут 1:', buttonIds);
                                                    //         if (originalCashoutClick1) {
                                                    //             return originalCashoutClick1.call(this, buttonIds);
                                                    //         }
                                                    //     };
                                                    // }
                                                    
                                                    // Логирование для onInteraction (включено для отладки кешаута)
                                                    const originalOnInteraction = sceneInstance.onInteraction;
                                                    sceneInstance.onInteraction = function(button, componentId) {
                                                        console.log('🖱️ Нажатие кнопки:', componentId, 'button:', button);
                                                        console.log('🔍 Проверка componentId:', { componentId, isCashOutBtn: componentId && componentId.indexOf("cash_out_btn") >= 0, isBetBtn: componentId && componentId.indexOf("bet_btn") >= 0 });
                                                        
                                                        // Проверяем, может ли _layout получить компонент
                                                        if (componentId && sceneInstance._layout) {
                                                            const component = sceneInstance._layout.getComponent(componentId);
                                                            console.log('🔍 Проверка _layout.getComponent:', { componentId, component: component, componentExists: !!component, componentInteractive: component ? component.interactive : 'N/A' });
                                                        }
                                                        
                                                        if (originalOnInteraction) {
                                                            return originalOnInteraction.call(this, button, componentId);
                                                        }
                                                    };
                                                    
                                                    // Логирование для onCashOutButtonClick
                                                    const originalOnCashOutButtonClick = sceneInstance.onCashOutButtonClick;
                                                    sceneInstance.onCashOutButtonClick = async function(buttonIds) {
                                                        console.log('💰 onCashOutButtonClick вызван с:', buttonIds);
                                                        console.log('💰 Проверяем ApplicationBase:', window.DO && window.DO.Common && window.DO.Common.ApplicationBase);
                                                        console.log('💰 Проверяем __gameApp:', window.__gameApp);
                                                        console.log('💰 Текущее состояние раунда:', window.__ws && window.__ws.__roundState);
                                                        
                                                        if (originalOnCashOutButtonClick) {
                                                            console.log('🔄 Вызываем оригинальный onCashOutButtonClick...');
                                                            try {
                                                                // Защищаем от зависания - устанавливаем таймаут
                                                                const timeoutPromise = new Promise((_, reject) => {
                                                                    setTimeout(() => reject(new Error('Timeout')), 2000);
                                                                });
                                                                
                                                                const originalPromise = Promise.resolve(originalOnCashOutButtonClick.call(this, buttonIds));
                                                                
                                                                const result = await Promise.race([originalPromise, timeoutPromise]);
                                                            console.log('💰 onCashOutButtonClick завершен, результат:', result);
                                                            } catch (error) {
                                                                console.log('⚠️ onCashOutButtonClick завершен с ошибкой/таймаутом:', error.message);
                                                                // Продолжаем выполнение даже если оригинальная функция зависла
                                                            }
                                                        }
                                                    };
                                                    
                                                    // Устанавливаем componentId для кнопок кешаута при инициализации
                                                    if (sceneInstance.cashout_btn_first && !sceneInstance.cashout_btn_first.componentId) {
                                                        sceneInstance.cashout_btn_first.componentId = "cash_out_btn";
                                                        // console.log('🔧 Установлен componentId для кнопки кешаута 1 при инициализации:', sceneInstance.cashout_btn_first.componentId);
                                                    }
                                                    
                                                    // Логирование для handleCommonDrawGameCashout
                                                    if (sceneInstance.handleCommonDrawGameCashout) {
                                                        const originalHandleCommonDrawGameCashout = sceneInstance.handleCommonDrawGameCashout;
                                                        sceneInstance.handleCommonDrawGameCashout = function(data) {
                                                            console.log('💰 handleCommonDrawGameCashout вызван с данными:', data);
                                                            console.log('💰 Структура данных handleCommonDrawGameCashout:', JSON.stringify(data, null, 2));
                                                            
                                                            if (originalHandleCommonDrawGameCashout) {
                                                                console.log('🔄 Вызываем оригинальный handleCommonDrawGameCashout...');
                                                                const result = originalHandleCommonDrawGameCashout.call(this, data);
                                                                console.log('💰 handleCommonDrawGameCashout завершен, результат:', result);
                                                                return result;
                                                            }
                                                        };
                                                        console.log('🔧 handleCommonDrawGameCashout перехвачен для логирования');
                                                    }
                                                    if (sceneInstance.cashout_btn_second && !sceneInstance.cashout_btn_second.componentId) {
                                                        sceneInstance.cashout_btn_second.componentId = "cash_out_btn_2";
                                                        // console.log('🔧 Установлен componentId для кнопки кешаута 2 при инициализации:', sceneInstance.cashout_btn_second.componentId);
                                                    }
                                                    
                                                    // Проверяем, зарегистрированы ли кнопки кешаута в _layout (отключено)
                                                    // if (sceneInstance._layout) {
                                                    //     const layoutCashout1 = sceneInstance._layout.getComponent("cash_out_btn");
                                                    //     const layoutCashout2 = sceneInstance._layout.getComponent("cash_out_btn_2");
                                                    //     console.log('🔍 Проверка _layout для кнопок кешаута:', { layoutCashout1: !!layoutCashout1, layoutCashout2: !!layoutCashout2, cashout1Same: layoutCashout1 === sceneInstance.cashout_btn_first, cashout2Same: layoutCashout2 === sceneInstance.cashout_btn_second });
                                                    // }
                                                    
                                                    // Проверяем состояние кнопок кешаута (отключено)
                                                    // console.log('🔍 Состояние кнопок кешаута:', { cashout_btn_first: sceneInstance.cashout_btn_first ? { visible: sceneInstance.cashout_btn_first.visible, interactive: sceneInstance.cashout_btn_first.interactive, buttonMode: sceneInstance.cashout_btn_first.buttonMode, componentId: sceneInstance.cashout_btn_first.componentId || 'не установлен' } : 'не найдена', cashout_btn_second: sceneInstance.cashout_btn_second ? { visible: sceneInstance.cashout_btn_second.visible, interactive: sceneInstance.cashout_btn_second.interactive, buttonMode: sceneInstance.cashout_btn_second.buttonMode, componentId: sceneInstance.cashout_btn_second.componentId || 'не установлен' } : 'не найдена' });
                                                    
                                                    // if (sceneInstance.cashout_btn_second) {
                                                    //     const originalCashoutClick2 = sceneInstance.onCashOutButtonClick;
                                                    //     sceneInstance.onCashOutButtonClick = function(buttonIds) {
                                                    //         console.log('💰 Кешаут 2:', buttonIds);
                                                    //         if (originalCashoutClick2) {
                                                    //             return originalCashoutClick2.call(this, buttonIds);
                                                    //         }
                                                    //     };
                                                    // }
                                                    
                                                    console.log('📝 Логирование кнопок настроено');
                                                }
                                            }
                                        };
                                        
                                        // Настраиваем логирование с задержкой
                                        setTimeout(addButtonLogging, 2000);
                                        setTimeout(addButtonLogging, 5000);
                                        setTimeout(addButtonLogging, 10000);
                                        setTimeout(addButtonLogging, 15000);
                                        
                                        // Также вызываем сразу
                                        addButtonLogging();
                                    
                                    // Перехватываем событие ставки
                                    // Логируем все доступные константы событий для ставок
                                    console.log('🔍 Ищем константы событий для ставок...');
                                    if (window.DO && window.DO.Common && window.DO.Common.Server) {
                                        console.log('🔍 Все свойства DO.Common.Server:', Object.keys(window.DO.Common.Server));
                                        // Ищем константы связанные с ENTER и CASHOUT
                                        const serverKeys = Object.keys(window.DO.Common.Server);
                                        const enterKeys = serverKeys.filter(key => key.includes('ENTER') || key.includes('enter'));
                                        const cashoutKeys = serverKeys.filter(key => key.includes('CASHOUT') || key.includes('cashout'));
                                        console.log('🔍 ENTER константы:', enterKeys);
                                        console.log('🔍 CASHOUT константы:', cashoutKeys);
                                    }
                                    
                                    window.__gameApp.on('SEND_ENTER_COMMON_DRAW_REQUEST', (data) => {
                                        console.log('🎲 Получена ставка:', data);
                                        
                                        // Блокируем кнопки ставок при получении ставки
                                        setTimeout(() => {
                                            if (window.__gameRenderer && window.__gameRenderer.SceneManager) {
                                                const sceneInstance = window.__gameRenderer.SceneManager.getCurrentScene();
                                                if (sceneInstance) {
                                                    console.log('🔒 Блокируем кнопки ставок при получении ставки...');
                                                    sceneInstance.__betButtonsBlocked = true;
                                                    
                                                    // Блокируем кнопки выбора ставок с визуальной блокировкой
                                                    if (sceneInstance.first_bet_button) {
                                                        sceneInstance.first_bet_button.updateButtonState(false);
                                                        sceneInstance.first_bet_button.interactive = false;
                                                        sceneInstance.first_bet_button.alpha = 0.5; // Делаем серыми
                                                    }
                                                    if (sceneInstance.second_bet_button) {
                                                        sceneInstance.second_bet_button.updateButtonState(false);
                                                        sceneInstance.second_bet_button.interactive = false;
                                                        sceneInstance.second_bet_button.alpha = 0.5; // Делаем серыми
                                                    }
                                                    if (sceneInstance.third_bet_button) {
                                                        sceneInstance.third_bet_button.updateButtonState(false);
                                                        sceneInstance.third_bet_button.interactive = false;
                                                        sceneInstance.third_bet_button.alpha = 0.5; // Делаем серыми
                                                    }
                                                    if (sceneInstance.fourth_bet_button) {
                                                        sceneInstance.fourth_bet_button.updateButtonState(false);
                                                        sceneInstance.fourth_bet_button.interactive = false;
                                                        sceneInstance.fourth_bet_button.alpha = 0.5; // Делаем серыми
                                                    }
                                                    
                                                    // Блокируем кнопки +/- ставок с визуальной блокировкой
                                                    if (sceneInstance.bet_minus_btn) {
                                                        sceneInstance.bet_minus_btn.updateButtonState(false);
                                                        sceneInstance.bet_minus_btn.interactive = false;
                                                        sceneInstance.bet_minus_btn.alpha = 0.5; // Делаем серыми
                                                    }
                                                    if (sceneInstance.bet_plus_btn) {
                                                        sceneInstance.bet_plus_btn.updateButtonState(false);
                                                        sceneInstance.bet_plus_btn.interactive = false;
                                                        sceneInstance.bet_plus_btn.alpha = 0.5; // Делаем серыми
                                                    }
                                                    
                                                    // Блокируем кнопки автокешаута с визуальной блокировкой
                                                    if (sceneInstance.autoCashOutToggle1) {
                                                        sceneInstance.autoCashOutToggle1.interactive = false;
                                                        sceneInstance.autoCashOutToggle1.alpha = 0.3; // Делаем очень серыми
                                                    }
                                                    
                                                    // Блокируем кнопку BET
                                                    if (sceneInstance.bet_btn_first) {
                                                        sceneInstance.bet_btn_first.updateButtonState(false);
                                                        sceneInstance.bet_btn_first.interactive = false;
                                                        sceneInstance.bet_btn_first.alpha = 0.5; // Делаем серыми
                                                    }
                                                    
                                                    console.log('✅ Кнопки ставок заблокированы при получении ставки');
                                                }
                                            }
                                        }, 100);
                                        
                                        // Сбрасываем состояние раунда для новой ставки
                                        if (ws.__roundState) {
                                            ws.__roundState.phase = 'open'; // Сначала открываем для сброса состояния
                                            ws.__roundState.countdownTime = 10;
                                            ws.__roundState.multiplier = 1.00;
                                            ws.__roundState.maxMultiplier = 0;
                                            ws.__roundState.endTimer = false;
                                            ws.__roundState.crashAnimationTime = 0;
                                            ws.__roundState.roundId = 'offline_round_' + Date.now();
                                            
                                // Сбрасываем флаг кешаута для нового раунда
                                if (ws.__roundState) {
                                    ws.__roundState.cashoutExecuted = false;
                                    console.log('🔄 Флаг кешаута сброшен в WebSocket моке при получении ставки');
                                }
                                
                                if (window.__gameRenderer && window.__gameRenderer.SceneManager) {
                                    const sceneInstance = window.__gameRenderer.SceneManager.getCurrentScene();
                                    if (sceneInstance) {
                                        sceneInstance.__cashoutExecuted = false;
                                        sceneInstance.__betButtonsBlocked = false;
                                        console.log('🔄 Флаги кешаута и блокировки сброшены для нового раунда');
                                        
                                        // Сбрасываем флаг кешаута в глобальном состоянии
                                        if (ws.__roundState) {
                                            ws.__roundState.cashoutExecuted = false;
                                        }
                                        
                                        // Разблокируем все кнопки при сбросе
                                        if (sceneInstance.first_bet_button) {
                                            sceneInstance.first_bet_button.updateButtonState(true);
                                            sceneInstance.first_bet_button.interactive = true;
                                            sceneInstance.first_bet_button.alpha = 1.0;
                                        }
                                        if (sceneInstance.second_bet_button) {
                                            sceneInstance.second_bet_button.updateButtonState(true);
                                            sceneInstance.second_bet_button.interactive = true;
                                            sceneInstance.second_bet_button.alpha = 1.0;
                                        }
                                        if (sceneInstance.third_bet_button) {
                                            sceneInstance.third_bet_button.updateButtonState(true);
                                            sceneInstance.third_bet_button.interactive = true;
                                            sceneInstance.third_bet_button.alpha = 1.0;
                                        }
                                        if (sceneInstance.fourth_bet_button) {
                                            sceneInstance.fourth_bet_button.updateButtonState(true);
                                            sceneInstance.fourth_bet_button.interactive = true;
                                            sceneInstance.fourth_bet_button.alpha = 1.0;
                                        }
                                        
                                        if (sceneInstance.bet_minus_btn) {
                                            sceneInstance.bet_minus_btn.updateButtonState(true);
                                            sceneInstance.bet_minus_btn.interactive = true;
                                            sceneInstance.bet_minus_btn.alpha = 1.0;
                                        }
                                        if (sceneInstance.bet_plus_btn) {
                                            sceneInstance.bet_plus_btn.updateButtonState(true);
                                            sceneInstance.bet_plus_btn.interactive = true;
                                            sceneInstance.bet_plus_btn.alpha = 1.0;
                                        }
                                        
                                        if (sceneInstance.autoCashOutToggle1) {
                                            sceneInstance.autoCashOutToggle1.interactive = true;
                                            sceneInstance.autoCashOutToggle1.alpha = 1.0;
                                        }
                                        
                                        console.log('✅ Все кнопки разблокированы при сбросе раунда');
                                    }
                                }
                                            
                                            // Сбрасываем флаги состояния игры
                                            if (window.__gameRenderer && window.__gameRenderer.SceneManager) {
                                                const sceneInstance = window.__gameRenderer.SceneManager.getCurrentScene();
                                                if (sceneInstance) {
                                                    sceneInstance.isFirstTimeLoad = true;
                                                    sceneInstance.loaderStarted = false;
                                                    sceneInstance.isRoundCounterStarted = false;
                                                    
                                                    // Инициализируем betData если не существует
                                                    if (!sceneInstance.betData) {
                                                        sceneInstance.betData = { 
                                                            bet1: { stake: 0, autoCashOutMultiplier: 0 }, 
                                                            bet2: { stake: 0, autoCashOutMultiplier: 0 } 
                                                        };
                                                    }
                                                    
                                                    // Инициализируем текстовые компоненты кешаута
                                                    if (sceneInstance.cash_out_btn_text) {
                                                        sceneInstance.cash_out_btn_text.visible = false;
                                                    }
                                                    if (sceneInstance.cash_out_btn_2_text) {
                                                        sceneInstance.cash_out_btn_2_text.visible = false;
                                                    }
                                                    
                                                    // Блокируем кнопки ставок после нажатия BET
                                                    console.log('🔒 Блокируем кнопки ставок...');
                                                    sceneInstance.__betButtonsBlocked = true;
                                                    
                                                    // ИСПОЛЬЗУЕМ ВСТРОЕННЫЕ ФУНКЦИИ БЛОКИРОВКИ
                                                    if (sceneInstance.disablePanelFirstBetPanel) {
                                                        sceneInstance.disablePanelFirstBetPanel();
                                                        console.log('🔒 BET WebSocket: Встроенная блокировка первой панели');
                                                    }
                                                    if (sceneInstance.disablePanelSecondBetPanel) {
                                                        sceneInstance.disablePanelSecondBetPanel();
                                                        console.log('🔒 BET WebSocket: Встроенная блокировка второй панели');
                                                    }
                                                    
                                                    // Прямая блокировка всех кнопок ставок
                                                    const buttonsToBlock = [
                                                        'first_bet_button', 'second_bet_button', 'third_bet_button', 'fourth_bet_button',
                                                        'first_bet_button_2', 'second_bet_button_2', 'third_bet_button_2', 'fourth_bet_button_2',
                                                        'plus_button', 'minus_button', 'plus_button_2', 'minus_button_2',
                                                        'bet_plus_btn', 'bet_minus_btn', 'bet_plus_btn_2', 'bet_minus_btn_2',
                                                        'autoCashOutToggle1', 'autoCashOutToggle2',
                                                        'bet_btn_first', 'bet_btn_second'
                                                    ];
                                                    
                                                    buttonsToBlock.forEach(buttonName => {
                                                        if (sceneInstance[buttonName]) {
                                                            if (sceneInstance[buttonName].updateButtonState) {
                                                                sceneInstance[buttonName].updateButtonState(false);
                                                            }
                                                            sceneInstance[buttonName].interactive = false;
                                                            sceneInstance[buttonName].alpha = 0.5;
                                                            console.log(`🔒 Заблокирована ${buttonName}`);
                                                        }
                                                    });
                                                    
                                                    if (sceneInstance.disablePanelFirstBetPanel) {
                                                        sceneInstance.disablePanelFirstBetPanel();
                                                        console.log('🔒 disablePanelFirstBetPanel вызван');
                                                    } else {
                                                        console.log('❌ disablePanelFirstBetPanel не найден');
                                                    }
                                                    if (sceneInstance.disablePanelSecondBetPanel) {
                                                        sceneInstance.disablePanelSecondBetPanel();
                                                        console.log('🔒 disablePanelSecondBetPanel вызван');
                                                    } else {
                                                        console.log('❌ disablePanelSecondBetPanel не найден');
                                                    }
                                                    console.log('🔒 Кнопки ставок заблокированы после BET');
                                                }
                                            }
                                            
                                            // Через небольшую задержку переходим в waiting
                                            setTimeout(() => {
                                                ws.__roundState.phase = 'waiting';
                                                console.log('🕐 Начинаем отсчет до нового раунда...');
                                            }, 100);
                                        }
                                        
                                        // Симулируем успешную ставку с правильной последовательностью
                                        setTimeout(() => {
                                            if (window.__gameApp) {
                                                // Сначала отправляем 'open' для сброса состояния
                                                window.__gameApp.emit('gameInProgress', {
                                                    rounds: [{
                                                        id: ws.__roundState?.roundId || 'offline_round_' + Date.now(),
                                                        status: 'open',
                                                        currentMultiplier: 0,
                                                        maxMultiplier: 0,
                                                        timeToStartInSeconds: 0
                                                    }]
                                                });
                                                
                                                // Затем через задержку отправляем 'getready'
                                                setTimeout(() => {
                                                    window.__gameApp.emit('gameInProgress', {
                                                        rounds: [{
                                                            id: ws.__roundState?.roundId || 'offline_round_' + Date.now(),
                                                            status: 'getready',
                                                            currentMultiplier: 1.00,
                                                            maxMultiplier: 0,
                                                            timeToStartInSeconds: 10
                                                        }]
                                                    });
                                                    console.log('🎯 Отправлено событие getready для UI ожидания');
                                                }, 50);
                                            }
                                        }, 100);
                                    });
                                    
                                    // Перехватываем событие кешаута
                                    window.__gameApp.on('SEND_CASHOUT_COMMON_DRAW_REQUEST', (data) => {
                                        console.log('💰 Получен запрос кешаута:', data);
                                        console.log('💰 Event listener: Структура данных кешаута:', JSON.stringify(data, null, 2));
                                        console.log('💰 Event listener: Обрабатываем кешаут...');
                                        
                                        // Обрабатываем кешаут
                                        setTimeout(() => {
                                            if (ws.__roundState && ws.__roundState.phase === 'active') {
                                                const currentMultiplier = ws.__roundState.multiplier;
                                                const betTypes = data.betData?.bet || [];
                                                
                                                // Получаем сумму ставки
                                                let totalBetAmount = 0;
                                                if (window.__gameRenderer && window.__gameRenderer.SceneManager) {
                                                    const sceneInstance = window.__gameRenderer.SceneManager.getCurrentScene();
                                                    if (sceneInstance && sceneInstance.betData) {
                                                        if (betTypes.includes("bet1") && sceneInstance.betData.bet1) {
                                                            totalBetAmount += sceneInstance.betData.bet1.stake || 0;
                                                        }
                                                        if (betTypes.includes("bet2") && sceneInstance.betData.bet2) {
                                                            totalBetAmount += sceneInstance.betData.bet2.stake || 0;
                                                        }
                                                    }
                                                }
                                                
                                                const winAmount = Math.floor(currentMultiplier * totalBetAmount);
                                                
                                                // Добавляем выигрыш к текущему балансу
                                                ws.__currentBalance += winAmount;
                                                
                                                console.log(`💰 Кеш-аут: ${currentMultiplier.toFixed(2)}x, выигрыш: ${winAmount} центов (${(winAmount / 100).toFixed(2)} EUR), новый баланс: ${ws.__currentBalance} центов (${(ws.__currentBalance / 100).toFixed(2)} EUR)`);
                                                
                                                // Отправляем событие кешаута
                                                const cashoutEventData = {
                                                    success: true,
                                                    action: 'cashoutCommonDraw',
                                                    balance: {
                                                        totalBalance: ws.__currentBalance,
                                                        currency: 'EUR',
                                                        currencyMultiplier: 100
                                                    },
                                                    result: {
                                                        win: winAmount,
                                                        multiplier: +currentMultiplier.toFixed(2),
                                                        cashedOut: true,
                                                        betAmount: totalBetAmount
                                                    },
                                                    betOption: {
                                                        bet1: betTypes.includes("bet1"),
                                                        bet2: betTypes.includes("bet2")
                                                    }
                                                };
                                                
                                                console.log('💰 Отправляем событие RECEIVE_COMMON_DRAW_CASHOUT:', cashoutEventData);
                                                window.__gameApp.emit('RECEIVE_COMMON_DRAW_CASHOUT', cashoutEventData);
                                                
                                                // Вызываем handleCommonDrawGameCashout напрямую
                                                if (window.__gameRenderer && window.__gameRenderer.SceneManager) {
                                                    const sceneInstance = window.__gameRenderer.SceneManager.getCurrentScene();
                                                    console.log('💰 sceneInstance для handleCommonDrawGameCashout:', sceneInstance);
                                                    console.log('💰 handleCommonDrawGameCashout функция:', sceneInstance && sceneInstance.handleCommonDrawGameCashout);
                                                    
                                                    if (sceneInstance && sceneInstance.handleCommonDrawGameCashout) {
                                                        console.log('💰 Вызываем handleCommonDrawGameCashout напрямую с данными:', cashoutEventData);
                                                        try {
                                                            const result = sceneInstance.handleCommonDrawGameCashout(cashoutEventData);
                                                            console.log('💰 handleCommonDrawGameCashout вернул:', result);
                                                        } catch (error) {
                                                            console.error('💰 Ошибка при вызове handleCommonDrawGameCashout:', error);
                                                        }
                                                    } else {
                                                        console.log('💰 handleCommonDrawGameCashout недоступен!');
                                                        console.log('💰 Доступные методы sceneInstance:', sceneInstance ? Object.getOwnPropertyNames(sceneInstance) : 'sceneInstance is null');
                                                    }
                                                } else {
                                                    console.log('💰 SceneManager недоступен для handleCommonDrawGameCashout');
                                                }
                                                
                                                // Альтернативный способ обновления баланса через DOM
                                                console.log('💰 Пытаемся обновить баланс через DOM...');
                                                const balanceElements = [
                                                    '#cp_balance',
                                                    '.balance',
                                                    '[data-balance]',
                                                    '.total-balance',
                                                    '#balance',
                                                    '.current-balance'
                                                ];
                                                
                                                let balanceUpdated = false;
                                                balanceElements.forEach(selector => {
                                                    const element = document.querySelector(selector);
                                                    if (element) {
                                                        const newBalance = (ws.__currentBalance / 100).toFixed(2);
                                                        element.textContent = newBalance;
                                                        console.log(`💰 Обновлен баланс в ${selector}: ${newBalance}`);
                                                        balanceUpdated = true;
                                                    }
                                                });
                                                
                                                if (!balanceUpdated) {
                                                    console.log('💰 Не найдены элементы баланса для обновления');
                                                    console.log('💰 Доступные элементы с текстом "balance":', 
                                                        Array.from(document.querySelectorAll('*')).filter(el => 
                                                            el.textContent && el.textContent.toLowerCase().includes('balance')
                                                        ).map(el => ({ tag: el.tagName, text: el.textContent.trim().substring(0, 50) }))
                                                    );
                                                }
                                                
                                                // Пытаемся показать WIN через DOM
                                                console.log('💰 Пытаемся показать WIN через DOM...');
                                                const winElements = [
                                                    '#cp_win',
                                                    '.win-popup',
                                                    '.win-message',
                                                    '[data-win]',
                                                    '.win-amount'
                                                ];
                                                
                                                let winShown = false;
                                                winElements.forEach(selector => {
                                                    const element = document.querySelector(selector);
                                                    if (element) {
                                                        const winAmountDisplay = (winAmount / 100).toFixed(2);
                                                        element.textContent = winAmountDisplay;
                                                        element.style.display = 'block';
                                                        element.style.visibility = 'visible';
                                                        console.log(`💰 Показан WIN в ${selector}: ${winAmountDisplay}`);
                                                        winShown = true;
                                                    }
                                                });
                                                
                                                if (!winShown) {
                                                    console.log('💰 Не найдены элементы WIN для отображения');
                                                }
                                            }
                                        }, 100);
                                        
                                    // Добавляем обработчик события RECEIVE_COMMON_DRAW_CASHOUT
                                    window.__gameApp.on('RECEIVE_COMMON_DRAW_CASHOUT', (data) => {
                                        console.log('💰 Получен ответ кешаута:', data);
                                        console.log('💰 Event listener: Обрабатываем ответ кешаута...');
                                        console.log('💰 Структура данных ответа кешаута:', JSON.stringify(data, null, 2));
                                        
                                        // Сбрасываем флаг кешаута сразу при получении ответа
                                        if (window.__gameRenderer && window.__gameRenderer.SceneManager) {
                                            const sceneInstance = window.__gameRenderer.SceneManager.getCurrentScene();
                                            if (sceneInstance) {
                                                console.log('🔄 Сбрасываем флаг кешаута при получении ответа');
                                                sceneInstance.__cashoutExecuted = false;
                                                console.log('✅ Флаг кешаута сброшен при получении ответа');
                                            }
                                        }
                                        
                                        // Вызываем handleCommonDrawGameCashout если доступен
                                        if (window.__gameRenderer && window.__gameRenderer.SceneManager) {
                                            const sceneInstance = window.__gameRenderer.SceneManager.getCurrentScene();
                                            console.log('💰 sceneInstance для обработки ответа кешаута:', sceneInstance);
                                            if (sceneInstance && sceneInstance.handleCommonDrawGameCashout) {
                                                console.log('💰 Вызываем handleCommonDrawGameCashout из обработчика события');
                                                try {
                                                    sceneInstance.handleCommonDrawGameCashout(data);
                                                } catch (error) {
                                                    console.error('💰 Ошибка при вызове handleCommonDrawGameCashout из обработчика:', error);
                                                }
                                            }
                                        }
                                        
                                        // Принудительно обновляем UI для кешаута
                                        setTimeout(() => {
                                            if (window.__gameRenderer && window.__gameRenderer.SceneManager) {
                                                const sceneInstance = window.__gameRenderer.SceneManager.getCurrentScene();
                                                if (sceneInstance && data.result) {
                                                    // Обновляем баланс
                                                    if (data.balance && data.balance.total) {
                                                        console.log('💰 Обновляем баланс:', data.balance.total);
                                                        // Обновляем баланс через DOM
                                                        const balanceElements = [
                                                            '#cp_balance',
                                                            '.balance_amount',
                                                            '.balance-text',
                                                            '[data-balance]'
                                                        ];
                                                        
                                                        balanceElements.forEach(selector => {
                                                            const element = document.querySelector(selector);
                                                            if (element) {
                                                                element.textContent = data.balance.total.toFixed(2);
                                                                console.log(`💰 Обновлен баланс в ${selector}:`, data.balance.total);
                                                            }
                                                        });
                                                    }
                                                    
                                                    // Показываем WIN
                                                    if (data.result.win && data.result.win > 0) {
                                                        console.log('💰 Показываем WIN:', data.result.win);
                                                        
                                                        // Обновляем WIN через DOM
                                                        const winElements = [
                                                            '#cp_win',
                                                            '.win_amount',
                                                            '.win-text',
                                                            '[data-win]'
                                                        ];
                                                        
                                                        winElements.forEach(selector => {
                                                            const element = document.querySelector(selector);
                                                            if (element) {
                                                                element.textContent = data.result.win.toFixed(2);
                                                                element.style.display = 'block';
                                                                element.style.visibility = 'visible';
                                                                console.log(`💰 Показан WIN в ${selector}:`, data.result.win);
                                                            }
                                                        });
                                                        
                                                        // Показываем WIN в игре
                                                        if (sceneInstance.showWinTextAnimation) {
                                                            try {
                                                                sceneInstance.showWinTextAnimation(data.result.win);
                                                                console.log('💰 Вызван showWinTextAnimation:', data.result.win);
                                                            } catch (error) {
                                                                console.error('💰 Ошибка при вызове showWinTextAnimation:', error);
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }, 100);
                                    });
                                        
                                        // Проверяем и инициализируем betData если нужно
                                        if (window.__gameRenderer && window.__gameRenderer.SceneManager) {
                                            const sceneInstance = window.__gameRenderer.SceneManager.getCurrentScene();
                                            if (sceneInstance && (!sceneInstance.betData || !sceneInstance.betData.bet1 || !sceneInstance.betData.bet2)) {
                                                sceneInstance.betData = { 
                                                    bet1: { stake: 0, autoCashOutMultiplier: 0 }, 
                                                    bet2: { stake: 0, autoCashOutMultiplier: 0 } 
                                                };
                                                
                                                // Инициализируем текстовые компоненты кешаута
                                                if (sceneInstance.cash_out_btn_text) {
                                                    sceneInstance.cash_out_btn_text.visible = false;
                                                }
                                                if (sceneInstance.cash_out_btn_2_text) {
                                                    sceneInstance.cash_out_btn_2_text.visible = false;
                                                }
                                                
                                                console.log('🔧 Инициализирован betData для кешаута');
                                            }
                                        }
                                        
                                        // Принудительно завершаем текущий раунд
                                        if (ws.__roundState && ws.__roundState.phase === 'active') {
                                            ws.__roundState.phase = 'crash_animation';
                                            ws.__roundState.maxMultiplier = ws.__roundState.multiplier;
                                            ws.__roundState.crashAnimationTime = 0;
                                            console.log(`💰 Кешаут выполнен на множителе: ${ws.__roundState.multiplier.toFixed(2)}x`);
                                            
                                            // Сразу вызываем onGameFinished для проигрывания анимации FELL OFF при кешауте
                                            setTimeout(() => {
                                                if (window.__gameRenderer && window.__gameRenderer.SceneManager) {
                                                    const sceneInstance = window.__gameRenderer.SceneManager.getCurrentScene();
                                                    if (sceneInstance && sceneInstance.onGameFinished) {
                                                        // Создаем объект события окончания игры (с кешаутом)
                                                        const gameFinishedEvent = {
                                                            isCashout: true, // Кешаут - ставки не горят
                                                            result: {
                                                                result: {
                                                                    maxMultiplier: ws.__roundState.multiplier
                                                                }
                                                            }
                                                        };
                                                        
                                                        console.log('💰 Вызываем onGameFinished для анимации FELL OFF при кешауте');
                                                        sceneInstance.onGameFinished(gameFinishedEvent);
                                                    }
                                                }
                                            }, 50);
                                            
                                            // Добавляем множитель в историю
                                            if (window.__gameRenderer && window.__gameRenderer.SceneManager) {
                                                const sceneInstance = window.__gameRenderer.SceneManager.getCurrentScene();
                                                if (sceneInstance && sceneInstance.historyText) {
                                                    const multiplierText = ws.__roundState.multiplier.toFixed(2) + "X";
                                                    sceneInstance.historyText.unshift(multiplierText);
                                                    if (sceneInstance.historyText.length > 6) {
                                                        sceneInstance.historyText.pop();
                                                    }
                                                    if (sceneInstance.writeHistory) {
                                                        sceneInstance.writeHistory();
                                                    }
                                                }
                                            }
                                        }
                                        
                                        // Симулируем успешный кешаут
                                        setTimeout(() => {
                                            if (window.__gameApp) {
                                                const currentMultiplier = ws.__roundState?.multiplier || 1.25;
                                                window.__gameApp.emit('gameInProgress', {
                                                    rounds: [{
                                                        id: ws.__roundState?.roundId || 'offline_round_' + Date.now(),
                                                        status: 'ended',
                                                        currentMultiplier: 0,
                                                        maxMultiplier: +currentMultiplier.toFixed(2),
                                                        timeToStartInSeconds: 0
                                                    }]
                                                });
                                                console.log('💰 Отправлено событие окончания раунда после кешаута');
                                            }
                                        }, 100);
                                    });
                                    
                                    console.log('✅ Перехват игровых событий настроен');
                                }
                            }
                        
                        // Ищем сцену игры
                        if (window.DO && window.DO.Core && window.DO.Core.Renderer) {
                            console.log('✅ Найден DO.Core.Renderer');
                            window.__gameRenderer = window.DO.Core.Renderer;
                        }
                        
                        // Пытаемся активировать игру принудительно
                        setTimeout(() => {
                            console.log('🔧 Принудительная активация игры...');
                            
                            // Ищем элементы игры в DOM
                            const gameWrapper = document.getElementById('game_wrapper');
                            if (gameWrapper) {
                                console.log('✅ Найден game_wrapper');
                                
                                // Кликаем в игру для активации
                                const clickEvent = new MouseEvent('click', {
                                    view: window,
                                    bubbles: true,
                                    cancelable: true
                                });
                                gameWrapper.dispatchEvent(clickEvent);
                                console.log('👆 Симулирован клик в игру');
                            }
                            
                            // Ищем canvas элементы
                            const canvases = document.querySelectorAll('canvas');
                            if (canvases.length > 0) {
                                console.log(`✅ Найдено ${canvases.length} canvas элементов`);
                                canvases.forEach((canvas, index) => {
                                    console.log(`Canvas ${index}: ${canvas.width}x${canvas.height}`);
                                    
                                    // Кликаем в каждый canvas для полной активации
                                    const clickEvent = new MouseEvent('click', {
                                        view: window,
                                        bubbles: true,
                                        cancelable: true
                                    });
                                    canvas.dispatchEvent(clickEvent);
                                });
                            }
                            
                            // Глобальное состояние анимаций
                            window.__animationState = {
                                currentPhase: 'idle', // idle, rising, crashed
                                spineAnimations: [],
                                lastPhaseChange: Date.now()
                            };
                            
                            // Добавляем глобальную функцию для управления анимациями
                            window.__setAnimationPhase = function(phase) {
                                // Защита от множественных вызовов с одинаковой фазой
                                const now = Date.now();
                                if (window.__animationState.currentPhase === phase && 
                                    (now - window.__animationState.lastPhaseChange) < 500) {
                                    return; // Игнорируем повторные вызовы той же фазы
                                }
                                
                                console.log(`🎬 Переключаем анимацию на фазу: ${phase}`);
                                window.__animationState.currentPhase = phase;
                                window.__animationState.lastPhaseChange = now;
                                window.__restartBananaAnimation();
                            };
                            
                            // Добавляем глобальную функцию для перезапуска анимации
                            window.__restartBananaAnimation = function() {
                                // Защита от множественных вызовов
                                const now = Date.now();
                                if (window.__animationState.lastRestart && (now - window.__animationState.lastRestart) < 100) {
                                    return; // Игнорируем вызовы чаще чем раз в 100мс
                                }
                                window.__animationState.lastRestart = now;
                                
                                try {
                                    console.log('🍌 Перезапускаем анимацию банана...');
                                    const currentPhase = window.__animationState.currentPhase;
                                    console.log(`📍 Текущая фаза: ${currentPhase}`);
                                    
                                    // Ищем Spine анимации
                                    if (window.PIXI && window.PIXI.spine) {
                                        console.log('✅ PIXI.spine найден');
                                    }
                                    
                                    // Пытаемся найти игровую сцену
                                    if (window.__gameRenderer && window.__gameRenderer.SceneManager) {
                                        const currentScene = window.__gameRenderer.SceneManager.getCurrentScene();
                                        if (currentScene) {
                                            console.log('✅ Найдена текущая сцена:', currentScene.constructor.name);
                                            
                                            // Пытаемся найти анимации банана
                                            if (currentScene.children) {
                                                const findAndControlSpineAnimations = (container, depth = 0) => {
                                                    if (depth > 5) return; // Ограничиваем глубину поиска
                                                    
                                                    container.children?.forEach((child, index) => {
                                                        // Более точная проверка на Spine анимацию
                                                        if (child.skeleton && child.state && typeof child.state.setAnimation === 'function') {
                                                            console.log(`🎭 Найдена Spine анимация ${index} (глубина ${depth})`);
                                                            
                                                            // Сохраняем ссылку на анимацию
                                                            if (!window.__animationState.spineAnimations.includes(child)) {
                                                                window.__animationState.spineAnimations.push(child);
                                                            }
                                                            
                                                            try {
                                                                // МИНИМАЛЬНОЕ вмешательство - только переключение анимации
                                                                // НЕ очищаем треки - это может повредить transform
                                                                // НЕ сбрасываем состояние - это может повредить кости
                                                                
                                                                // Получаем список доступных анимаций
                                                                let availableAnimations = [];
                                                                if (child.skeleton && child.skeleton.data && child.skeleton.data.animations) {
                                                                    availableAnimations = child.skeleton.data.animations.map(anim => anim.name);
                                                                    console.log(`📋 Доступные анимации: ${availableAnimations.join(', ')}`);
                                                                }
                                                                
                                                                // Выбираем анимацию в зависимости от фазы
                                                                let targetAnimation = null;
                                                                
                                                if (currentPhase === 'rising') {
                                                    // Анимации для роста множителя - сначала transition (прыжок), потом multiply
                                                    const risingAnimations = [
                                                        'banana_bonanza_landscape_transition', 'transition', 'jump', 'rise',
                                                        'banana_bonanza_landscape_multiply', 'multiply', 'up', 
                                                        'banana_up', 'banana_rise', 'animation', 'default'
                                                    ];
                                                    targetAnimation = risingAnimations.find(name => availableAnimations.includes(name));
                                                                } else if (currentPhase === 'crashed') {
                                                                    // Анимации для краша
                                                                    const crashAnimations = [
                                                                        'banana_bonanza_landscape_crash_and_fall', 'crash', 'fall', 
                                                                        'down', 'banana_fall', 'banana_crash', 'end'
                                                                    ];
                                                                    targetAnimation = crashAnimations.find(name => availableAnimations.includes(name));
                                                                } else {
                                                                    // Дефолтная анимация
                                                                    const defaultAnimations = [
                                                                        'banana_bonanza_landscape_idle', 'idle', 'animation', 'default'
                                                                    ];
                                                                    targetAnimation = defaultAnimations.find(name => availableAnimations.includes(name));
                                                                }
                                                                
                                                                // Если не нашли подходящую анимацию, берем первую доступную
                                                                if (!targetAnimation && availableAnimations.length > 0) {
                                                                    targetAnimation = availableAnimations[0];
                                                                }
                                                                
                                                                if (targetAnimation) {
                                                                    const loop = currentPhase === 'rising'; // Зацикливаем только анимацию роста
                                                                    
                                                                    // Небольшая задержка для правильного переключения анимации
                                                                    setTimeout(() => {
                                                                        try {
                                                                            // ТОЛЬКО переключение анимации - никаких других изменений!
                                                                            if (currentPhase === 'rising' && targetAnimation === 'banana_bonanza_landscape_transition') {
                                                                                // Сначала играем transition (прыжок на полку), потом multiply (взбирание)
                                                                                child.state.setAnimation(0, targetAnimation, false); // НЕ зацикливаем transition
                                                                                console.log(`🔄 Запущена анимация перехода "${targetAnimation}"`);
                                                                                
                                                                                // После завершения transition запускаем multiply
                                                                                setTimeout(() => {
                                                                                    try {
                                                                                        if (availableAnimations.includes('banana_bonanza_landscape_multiply')) {
                                                                                            child.state.setAnimation(0, 'banana_bonanza_landscape_multiply', true);
                                                                                            console.log(`🔄 Запущена анимация взбирания "banana_bonanza_landscape_multiply" (зацикленная)`);
                                                                                        }
                                                                                    } catch (e) {
                                                                                        console.log(`⚠️ Ошибка запуска multiply анимации:`, e);
                                                                                    }
                                                                                }, 1000); // 1 секунда на transition анимацию
                                                                            } else {
                                                                                // Обычное переключение для других анимаций
                                                                                child.state.setAnimation(0, targetAnimation, loop);
                                                                                console.log(`🔄 Запущена анимация "${targetAnimation}" (зацикленная: ${loop})`);
                                                                            }
                                                                        } catch (e) {
                                                                            console.log(`⚠️ Ошибка установки анимации "${targetAnimation}":`, e);
                                                                        }
                                                                        
                                                                    }, 50);
                                                                } else {
                                                                    console.log('⚠️ Не найдено подходящих анимаций');
                                                                }
                                                                
                                                                // Принудительное обновление
                                                                if (child.update) {
                                                                    child.update(0.016); // 60 FPS
                                                                }
                                                                
                                                            } catch (error) {
                                                                console.log(`⚠️ Ошибка управления анимацией ${index}:`, error);
                                                            }
                                                        }
                                                        
                                                        // Рекурсивно ищем в дочерних объектах
                                                        if (child.children && child.children.length > 0) {
                                                            findAndControlSpineAnimations(child, depth + 1);
                                                        }
                                                    });
                                                };
                                                
                                                findAndControlSpineAnimations(currentScene);
                                            }
                                        }
                                    }
                                    
                                    // Дополнительные методы активации
                                    setTimeout(() => {
                                        // Принудительное обновление всех canvas
                                        const canvases = document.querySelectorAll('canvas');
                                        canvases.forEach(canvas => {
                                            if (canvas.getContext) {
                                                const ctx = canvas.getContext('2d');
                                                if (ctx) {
                                                    // Принудительная перерисовка
                                                    ctx.save();
                                                    ctx.restore();
                                                }
                                            }
                                        });
                                        
                                        // Попытка перезапуска через PIXI Application
                                        if (window.PIXI && window.PIXI.Application) {
                                            console.log('🎨 Попытка перезапуска через PIXI.Application');
                                        }
                                        
                                        // Поиск анимаций через глобальные объекты
                                        if (window.DO && window.DO.RendererScenes) {
                                            console.log('🔍 Поиск через DO.RendererScenes...');
                                            Object.keys(window.DO.RendererScenes).forEach(key => {
                                                console.log(`Найдена сцена: ${key}`);
                                            });
                                        }
                                        
                                    }, 500);
                                    
                                } catch (error) {
                                    console.log('❌ Ошибка перезапуска анимации банана:', error);
                                }
                            };
                        }, 3000);
                    }, 2000);
                }, 5000);
            })();
            
            function loadGame() {
                let app = new DO.App();
                app.hoelleConnector = {
                    OI:OperatorInterface,
                    RLX: {
                        on: on,
                        send: send,
                        configure:configure
                    }
                };
                app.init();
            }
        </script>

        <script src="../common/lib/hoelle/rlxfeim.js?v=1.0.0"></script>
        <script src="../common/lib/hoelle/operatorInterface.js?v=1.0.0"></script>
        <script src="../common/lib/jquery-1.11.3.min.js?v=1.0.0"></script>
        <script src="../common/lib/pixi.min.js?v=1.0.0"></script>
        <script src="../common/lib/pixi-spine.js?v=1.0.0"></script>
        <script src="../common/lib/howler.min.js?v=1.0.0"></script>
        <script src="../common/lib/TweenLite.min.js?v=1.0.0"></script>
        <script src="../common/lib/EasePack.min.js?v=1.0.0"></script>
        <script src="../common/lib/TimelineLite.min.js?v=1.0.0"></script>
        <script src="../common/lib/TweenMax.min.js?v=1.0.0"></script>
        <script src="../common/lib/screenfull.js?v=1.0.0"></script>
        <script src="../common/lib/webfont.min.js?v=1.0.0"></script>
        <script src="../common/lib/platform.js?v=1.0.0"></script>
        <script src="../common/lib/vex.js?v=1.0.0"></script>
        <script src="../common/lib/vex.dialog.js?v=1.0.0"></script>
        <script src="../common/lib/require.js?v=1.0.0"></script>
        <script src="../common/lib/iscoop-playzia-hoelle-1.0.0.js?v=1.0.0"></script>
        <script src="./src/app.js?v=1.0.0"></script>

    </body>

</html>